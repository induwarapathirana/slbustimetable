<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - User Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" autocomplete="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" autocomplete="current-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Login</button>
                <p id="login-error" class="text-red-500 text-sm text-center"></p>
            </form>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <header class="bg-white shadow-md">
            <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">User Management</h1>
                <div>
                    <a href="/admin.html" class="text-indigo-600 hover:underline mr-4">Bus Schedule Admin</a>
                    <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600">Logout</button>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-4 md:p-6">
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-bold mb-4">Add New User</h2>
                <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div>
                        <label for="new-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="new-email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="new-password" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="At least 8 characters" required>
                    </div>
                    <div>
                        <label for="new-role" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="new-role" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <option value="timekeeper">Time Keeper</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div id="depot-field-container">
                        <label for="new-depot" class="block text-sm font-medium text-gray-700">Depot</label>
                        <input type="text" id="new-depot" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Makumbura">
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Create User</button>
                    </div>
                </form>
                <p id="add-user-message" class="text-sm mt-4"></p>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">Existing Users</h2>
                <div id="user-list-loading">Loading users...</div>
                <div class="overflow-x-auto">
                    <table id="user-table" class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Depot</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
    const TOKEN_KEY = 'slbustimetable:token';
    const state = {
        token: localStorage.getItem(TOKEN_KEY) || null,
        currentUser: null,
        users: []
    };

    const loginScreen = document.getElementById('login-screen');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const logoutButton = document.getElementById('logout-button');
    const loginError = document.getElementById('login-error');

    const addUserForm = document.getElementById('add-user-form');
    const addUserMessage = document.getElementById('add-user-message');
    const newRoleSelect = document.getElementById('new-role');
    const newDepotInput = document.getElementById('new-depot');
    const depotFieldContainer = document.getElementById('depot-field-container');

    const userTable = document.getElementById('user-table');
    const userTableBody = document.getElementById('user-table-body');
    const userListLoading = document.getElementById('user-list-loading');

    function setToken(token) {
        state.token = token;
        if (token) {
            localStorage.setItem(TOKEN_KEY, token);
        } else {
            localStorage.removeItem(TOKEN_KEY);
        }
    }

    function setCurrentUser(user) {
        state.currentUser = user || null;
    }

    function showDashboard() {
        loginScreen.classList.add('hidden');
        dashboard.classList.remove('hidden');
    }

    function showLogin(message = '') {
        loginScreen.classList.remove('hidden');
        dashboard.classList.add('hidden');
        if (message) {
            loginError.textContent = message;
        }
    }

    async function fetchWithAuth(url, options = {}) {
        const headers = new Headers(options.headers || {});
        headers.set('Content-Type', 'application/json');
        if (state.token) {
            headers.set('Authorization', `Bearer ${state.token}`);
        }
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401) {
            setToken(null);
            setCurrentUser(null);
            showLogin('Your session has expired. Please sign in again.');
            throw new Error('Unauthorized');
        }
        return response;
    }

    function renderUsers() {
        userTableBody.innerHTML = '';
        if (!state.users.length) {
            userTable.classList.add('hidden');
            userListLoading.textContent = 'No users found.';
            userListLoading.style.display = 'block';
            return;
        }

        userListLoading.style.display = 'none';
        userTable.classList.remove('hidden');

        state.users.forEach((user) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
                <td class="px-6 py-4 whitespace-nowrap capitalize">${user.role}</td>
                <td class="px-6 py-4 whitespace-nowrap">${user.depot || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right">
                    <button class="text-red-600 hover:text-red-900 delete-user-btn" data-id="${user.id}">Delete</button>
                </td>
            `;
            userTableBody.appendChild(row);
        });
    }

    async function loadUsers() {
        userListLoading.textContent = 'Loading users...';
        userListLoading.style.display = 'block';
        userTable.classList.add('hidden');

        try {
            const response = await fetchWithAuth('/api/users');
            if (!response.ok) {
                throw new Error('Failed to load users.');
            }
            state.users = await response.json();
            renderUsers();
        } catch (error) {
            console.error('Error loading users:', error);
            userListLoading.textContent = 'Failed to load users.';
        }
    }

    function toggleDepotField() {
        const showDepot = newRoleSelect.value === 'timekeeper';
        depotFieldContainer.style.display = showDepot ? 'block' : 'none';
        newDepotInput.required = showDepot;
        if (!showDepot) {
            newDepotInput.value = '';
        }
    }

    async function handleLogin(event) {
        event.preventDefault();
        loginError.textContent = '';

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
                throw new Error(data.message || 'Unable to sign in.');
            }

            if (data.user?.role !== 'admin') {
                throw new Error('You must be an administrator to access this page.');
            }

            setToken(data.token);
            setCurrentUser(data.user);
            showDashboard();
            await loadUsers();
            loginForm.reset();
        } catch (error) {
            console.error('Login failed:', error);
            setToken(null);
            setCurrentUser(null);
            loginError.textContent = error.message;
        }
    }

    function handleLogout() {
        setToken(null);
        setCurrentUser(null);
        state.users = [];
        renderUsers();
        showLogin();
    }

    async function handleAddUser(event) {
        event.preventDefault();
        addUserMessage.textContent = '';
        addUserMessage.className = 'text-sm mt-4';

        const email = document.getElementById('new-email').value.trim();
        const password = document.getElementById('new-password').value;
        const role = newRoleSelect.value;
        const depot = newDepotInput.value.trim();

        const payload = {
            email,
            password,
            role,
            depot: role === 'timekeeper' ? depot : null
        };

        try {
            const response = await fetchWithAuth('/api/users', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
                const errors = data.errors ? data.errors.join(', ') : data.message;
                throw new Error(errors || 'Failed to create user.');
            }

            addUserMessage.textContent = `Created user ${data.email}.`;
            addUserMessage.classList.add('text-green-600');
            addUserForm.reset();
            newRoleSelect.value = 'timekeeper';
            toggleDepotField();
            await loadUsers();
        } catch (error) {
            console.error('Failed to create user:', error);
            addUserMessage.textContent = error.message;
            addUserMessage.classList.add('text-red-600');
        }
    }

    async function handleDeleteUser(event) {
        const button = event.target.closest('.delete-user-btn');
        if (!button) return;

        const id = Number(button.dataset.id);
        if (!id) return;

        if (state.currentUser && state.currentUser.id === id) {
            alert('You cannot delete your own account.');
            return;
        }

        if (!confirm('Delete this user?')) {
            return;
        }

        try {
            const response = await fetchWithAuth(`/api/users/${id}`, { method: 'DELETE' });
            if (!response.ok && response.status !== 204) {
                const data = await response.json().catch(() => ({}));
                throw new Error(data.message || 'Failed to delete user.');
            }
            await loadUsers();
        } catch (error) {
            console.error('Failed to delete user:', error);
            alert(error.message);
        }
    }

    async function bootstrap() {
        toggleDepotField();

        if (state.token) {
            try {
                const response = await fetchWithAuth('/api/me');
                if (!response.ok) {
                    throw new Error('Unable to verify current user.');
                }
                const user = await response.json();
                if (user.role !== 'admin') {
                    throw new Error('You do not have access to this page.');
                }
                setCurrentUser(user);
                showDashboard();
                await loadUsers();
                return;
            } catch (error) {
                console.warn('Session bootstrap failed:', error);
                setToken(null);
                setCurrentUser(null);
            }
        }

        showLogin();
    }

    loginForm.addEventListener('submit', handleLogin);
    logoutButton.addEventListener('click', handleLogout);
    addUserForm.addEventListener('submit', handleAddUser);
    newRoleSelect.addEventListener('change', toggleDepotField);
    userTableBody.addEventListener('click', handleDeleteUser);

    bootstrap();
</script>
</body>
</html>
