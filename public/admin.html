<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Bus Timetables</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for draggable rows */
        .dragging {
            opacity: 0.5;
            background: #f0f8ff;
        }
        tr {
            cursor: grab;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-200">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Sign In</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" value="admin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" value="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300">
                    Sign In
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
        </div>
    </div>
    
    <!-- Main Dashboard (hidden by default) -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                <button id="logout-btn" class="text-sm text-indigo-600 hover:underline">Logout</button>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-6">
            <!-- Add Bus Section -->
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Add New Bus Route</h2>
                <form id="add-bus-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" name="route" placeholder="Route No. (e.g., X93)" class="p-2 border rounded" required>
                    <input type="text" name="operator" placeholder="Operator" class="p-2 border rounded" required>
                    <input type="text" name="departsFrom" placeholder="From" class="p-2 border rounded" required>
                    <input type="text" name="arrivesAt" placeholder="To" class="p-2 border rounded" required>
                    <input type="time" name="departureTime" class="p-2 border rounded" required>
                    <input type="time" name="arrivalTime" class="p-2 border rounded" required>
                    <input type="text" name="price" placeholder="Price (e.g., Â£25.00)" class="p-2 border rounded" required>
                    <input type="text" name="stops" placeholder="Stops (comma-separated)" class="md:col-span-2 p-2 border rounded" required>
                    <button type="submit" class="bg-indigo-600 text-white font-bold p-2 rounded hover:bg-indigo-700 transition duration-300">
                        <i class="fas fa-plus mr-2"></i> Add Bus
                    </button>
                </form>
            </div>

            <!-- Bus Timetables List -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="p-6 border-b">
                     <h2 class="text-xl font-semibold text-gray-800">Current Bus Timetables</h2>
                     <p class="text-sm text-gray-600 mt-1">Drag and drop rows to change the order.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-full text-sm">
                        <thead class="bg-gray-100 text-gray-600 uppercase">
                            <tr>
                                <th class="py-3 px-4 text-left">Route</th>
                                <th class="py-3 px-4 text-left">From</th>
                                <th class="py-3 px-4 text-left">To</th>
                                <th class="py-3 px-4 text-left">Departure</th>
                                <th class="py-3 px-4 text-left">Arrival</th>
                                <th class="py-3 px-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bus-table-body" class="text-gray-700">
                            <!-- Bus rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold">Edit Bus Route</p>
                    <button id="modal-close" class="modal-close cursor-pointer z-50">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="edit-bus-form">
                    <!-- Form fields will be populated by JS -->
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const API_URL = 'http://localhost:3000/api'; // Change this URL when you deploy
        let authToken = sessionStorage.getItem('authToken');

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const dashboard = document.getElementById('dashboard');
        const logoutBtn = document.getElementById('logout-btn');
        
        const tableBody = document.getElementById('bus-table-body');
        const addForm = document.getElementById('add-bus-form');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-bus-form');
        const modalClose = document.getElementById('modal-close');

        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });

                if (!response.ok) {
                    throw new Error('Invalid username or password.');
                }
                const data = await response.json();
                authToken = data.token;
                sessionStorage.setItem('authToken', authToken);
                showDashboard();
            } catch (error) {
                loginError.textContent = error.message;
            }
        });

        logoutBtn.addEventListener('click', () => {
            authToken = null;
            sessionStorage.removeItem('authToken');
            loginScreen.style.display = 'flex';
            dashboard.classList.add('hidden');
        });

        const showDashboard = () => {
            loginScreen.style.display = 'none';
            dashboard.classList.remove('hidden');
            fetchAndRenderTable();
        };

        // Check if user is already logged in
        if (authToken) {
            showDashboard();
        }

        // --- API HELPERS ---
        const fetchWithAuth = async (url, options = {}) => {
            const headers = {
                ...options.headers,
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`,
            };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) { // Unauthorized
                logoutBtn.click();
                throw new Error('Session expired. Please log in again.');
            }
            if (!response.ok) {
                 const err = await response.json();
                 throw new Error(err.message || 'An API error occurred.');
            }
            return response.json();
        };
        
        // --- RENDER FUNCTION ---
        const fetchAndRenderTable = async () => {
            try {
                const buses = await fetchWithAuth(`${API_URL}/buses`);
                tableBody.innerHTML = '';
                buses.forEach((bus, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.setAttribute('draggable', 'true');
                    row.dataset.id = bus.id;
                    row.dataset.index = index;

                    row.innerHTML = `
                        <td class="py-3 px-4">${bus.route} <span class="text-xs text-gray-500">(${bus.operator})</span></td>
                        <td class="py-3 px-4">${bus.departsFrom}</td>
                        <td class="py-3 px-4">${bus.arrivesAt}</td>
                        <td class="py-3 px-4 font-mono">${bus.departureTime}</td>
                        <td class="py-3 px-4 font-mono">${bus.arrivalTime}</td>
                        <td class="py-3 px-4 text-center">
                            <button class="edit-btn text-blue-500 hover:text-blue-700 p-1" data-id="${bus.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn text-red-500 hover:text-red-700 p-1" data-id="${bus.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                addEventListeners();
            } catch (error) {
                alert(`Error fetching data: ${error.message}`);
            }
        };

        // --- CRUD OPERATIONS ---
        
        // Add Bus
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(addForm);
            const newBus = {
                route: formData.get('route'),
                operator: formData.get('operator'),
                departsFrom: formData.get('departsFrom'),
                arrivesAt: formData.get('arrivesAt'),
                departureTime: formData.get('departureTime'),
                arrivalTime: formData.get('arrivalTime'),
                price: formData.get('price'),
                stops: formData.get('stops').split(',').map(s => s.trim()),
            };
            
            try {
                await fetchWithAuth(`${API_URL}/buses`, {
                    method: 'POST',
                    body: JSON.stringify(newBus),
                });
                addForm.reset();
                fetchAndRenderTable();
            } catch (error) {
                alert(`Error adding bus: ${error.message}`);
            }
        });

        // Handle Delete and Edit button clicks
        const handleTableClick = async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const busId = Number(target.dataset.id);

            if (target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this route?')) {
                    try {
                        await fetchWithAuth(`${API_URL}/buses/${busId}`, { method: 'DELETE' });
                        fetchAndRenderTable();
                    } catch (error) {
                        alert(`Error deleting bus: ${error.message}`);
                    }
                }
            }

            if (target.classList.contains('edit-btn')) {
                openEditModal(busId);
            }
        };

        // --- EDIT MODAL ---
        const openEditModal = async (busId) => {
            try {
                const bus = await fetchWithAuth(`${API_URL}/buses/${busId}`);
                editForm.innerHTML = `
                    <input type="hidden" name="id" value="${bus.id}">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm">Route</label><input type="text" name="route" value="${bus.route}" class="w-full p-2 border rounded mt-1"></div>
                        <div><label class="block text-sm">Operator</label><input type="text" name="operator" value="${bus.operator}" class="w-full p-2 border rounded mt-1"></div>
                        <div><label class="block text-sm">From</label><input type="text" name="departsFrom" value="${bus.departsFrom}" class="w-full p-2 border rounded mt-1"></div>
                        <div><label class="block text-sm">To</label><input type="text" name="arrivesAt" value="${bus.arrivesAt}" class="w-full p-2 border rounded mt-1"></div>
                        <div><label class="block text-sm">Departure</label><input type="time" name="departureTime" value="${bus.departureTime}" class="w-full p-2 border rounded mt-1"></div>
                        <div><label class="block text-sm">Arrival</label><input type="time" name="arrivalTime" value="${bus.arrivalTime}" class="w-full p-2 border rounded mt-1"></div>
                        <div class="col-span-2"><label class="block text-sm">Price</label><input type="text" name="price" value="${bus.price}" class="w-full p-2 border rounded mt-1"></div>
                        <div class="col-span-2"><label class="block text-sm">Stops (comma-separated)</label><input type="text" name="stops" value="${bus.stops.join(', ')}" class="w-full p-2 border rounded mt-1"></div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700">Save Changes</button>
                    </div>
                `;
                editModal.classList.remove('pointer-events-none', 'opacity-0');
                document.body.classList.add('modal-active');
            } catch (error) {
                alert(`Error fetching bus details: ${error.message}`);
            }
        };

        const closeEditModal = () => {
            editModal.classList.add('pointer-events-none', 'opacity-0');
            document.body.classList.remove('modal-active');
        };
        
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(editForm);
            const busId = Number(formData.get('id'));
            const updatedBus = {
                route: formData.get('route'),
                operator: formData.get('operator'),
                departsFrom: formData.get('departsFrom'),
                arrivesAt: formData.get('arrivesAt'),
                departureTime: formData.get('departureTime'),
                arrivalTime: formData.get('arrivalTime'),
                price: formData.get('price'),
                stops: formData.get('stops').split(',').map(s => s.trim()),
            };

            try {
                await fetchWithAuth(`${API_URL}/buses/${busId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedBus),
                });
                closeEditModal();
                fetchAndRenderTable();
            } catch (error) {
                alert(`Error updating bus: ${error.message}`);
            }
        });

        modalClose.addEventListener('click', closeEditModal);

        // --- DRAG AND DROP LOGIC ---
        let dragStartIndex;

        const reorderBuses = async (orderedIds) => {
             try {
                await fetchWithAuth(`${API_URL}/buses/order`, {
                    method: 'POST',
                    body: JSON.stringify({ orderedIds }),
                });
                fetchAndRenderTable();
            } catch (error) {
                alert(`Error reordering buses: ${error.message}`);
                fetchAndRenderTable(); // Re-render to revert visual change
            }
        };

        const dragStart = (e) => {
            dragStartIndex = +e.target.dataset.index;
            e.target.classList.add('dragging');
        };

        const dragOver = (e) => e.preventDefault();

        const drop = (e) => {
            const dropTarget = e.target.closest('tr');
            if (!dropTarget) return;

            const dragEndIndex = +dropTarget.dataset.index;
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            
            // Reorder the rows visually first for responsiveness
            const draggedRow = rows[dragStartIndex];
            const targetRow = rows[dragEndIndex];

            if (dragStartIndex < dragEndIndex) {
                targetRow.after(draggedRow);
            } else {
                targetRow.before(draggedRow);
            }

            // Get the new order of IDs and send to backend
            const orderedIds = Array.from(tableBody.querySelectorAll('tr')).map(row => Number(row.dataset.id));
            reorderBuses(orderedIds);
        };
        
        // --- ATTACH ALL EVENT LISTENERS ---
        const addEventListeners = () => {
            document.querySelectorAll('#bus-table-body tr').forEach(row => {
                row.addEventListener('dragstart', dragStart);
                row.addEventListener('dragover', dragOver);
                row.addEventListener('drop', drop);
                row.addEventListener('dragend', () => row.classList.remove('dragging'));
            });
            tableBody.addEventListener('click', handleTableClick);
        };
        
    </script>
</body>
</html>

