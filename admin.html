<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Bus Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6">Admin Panel Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" autocomplete="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" autocomplete="current-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Login</button>
                <p id="login-error" class="text-red-500 text-sm text-center"></p>
            </form>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <header class="bg-white shadow-md">
            <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold">Bus Schedule Management</h1>
                <div>
                    <a href="/user_management.html" class="text-indigo-600 hover:underline mr-4 font-semibold">Manage Users</a>
                    <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600">Logout</button>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-4 md:p-6">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Current Bus Timetable</h2>
                    <p class="text-gray-600">Manage the central SQLite-backed timetable via the secured API.</p>
                </div>
                <div class="flex gap-3">
                    <button id="show-add-modal" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 shadow">Add Single Bus</button>
                    <button id="show-bulk-add-modal" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 shadow">Bulk Add by Frequency</button>
                    <button id="refresh-button" class="bg-slate-200 text-slate-700 py-2 px-4 rounded-md hover:bg-slate-300 shadow">Refresh</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">Price Matrix</h2>
                        <p class="text-sm text-gray-500">Maintain reusable fare presets and departure locations for quick bus creation.</p>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="inline-flex items-center justify-center w-2.5 h-2.5 rounded-full bg-green-500"></span>
                        <span>Updates sync instantly with all admin and timekeeper tools.</span>
                    </div>
                </div>

                <form id="price-matrix-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    <input list="location-options" type="text" id="price-origin" class="w-full p-2 border rounded" placeholder="Origin (e.g., Makumbura)" required>
                    <input list="location-options" type="text" id="price-destination" class="w-full p-2 border rounded" placeholder="Destination (e.g., Galle)" required>
                    <input type="text" id="price-amount" class="w-full p-2 border rounded" placeholder="Price (e.g., 1200 LKR)" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Save</button>
                        <button type="button" id="price-form-reset" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-50">Clear</button>
                    </div>
                    <p id="price-form-message" class="md:col-span-2 lg:col-span-1 text-sm font-medium"></p>
                    <input type="hidden" id="price-entry-id">
                </form>

                <div id="price-matrix-empty" class="hidden text-center text-gray-500 py-6">No price entries yet. Add your first fare preset above.</div>
                <div class="overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-500">
                            <tr>
                                <th class="px-4 py-3 text-left">Origin</th>
                                <th class="px-4 py-3 text-left">Destination</th>
                                <th class="px-4 py-3 text-left">Price</th>
                                <th class="px-4 py-3 text-left">Last Updated</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="price-matrix-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">Price Matrix</h2>
                        <p class="text-sm text-gray-500">Maintain reusable fare presets and departure locations for quick bus creation.</p>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="inline-flex items-center justify-center w-2.5 h-2.5 rounded-full bg-green-500"></span>
                        <span>Updates sync instantly with all admin and timekeeper tools.</span>
                    </div>
                </div>

                <form id="price-matrix-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    <input list="location-options" type="text" id="price-origin" class="w-full p-2 border rounded" placeholder="Origin (e.g., Makumbura)" required>
                    <input list="location-options" type="text" id="price-destination" class="w-full p-2 border rounded" placeholder="Destination (e.g., Galle)" required>
                    <input type="text" id="price-amount" class="w-full p-2 border rounded" placeholder="Price (e.g., 1200 LKR)" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Save</button>
                        <button type="button" id="price-form-reset" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-50">Clear</button>
                    </div>
                    <p id="price-form-message" class="md:col-span-2 lg:col-span-1 text-sm font-medium"></p>
                    <input type="hidden" id="price-entry-id">
                </form>

                <div id="price-matrix-empty" class="hidden text-center text-gray-500 py-6">No price entries yet. Add your first fare preset above.</div>
                <div class="overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-500">
                            <tr>
                                <th class="px-4 py-3 text-left">Origin</th>
                                <th class="px-4 py-3 text-left">Destination</th>
                                <th class="px-4 py-3 text-left">Price</th>
                                <th class="px-4 py-3 text-left">Last Updated</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="price-matrix-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">Price Matrix</h2>
                        <p class="text-sm text-gray-500">Maintain reusable fare presets and departure locations for quick bus creation.</p>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="inline-flex items-center justify-center w-2.5 h-2.5 rounded-full bg-green-500"></span>
                        <span>Updates sync instantly with all admin and timekeeper tools.</span>
                    </div>
                </div>

                <form id="price-matrix-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    <input list="location-options" type="text" id="price-origin" class="w-full p-2 border rounded" placeholder="Origin (e.g., Makumbura)" required>
                    <input list="location-options" type="text" id="price-destination" class="w-full p-2 border rounded" placeholder="Destination (e.g., Galle)" required>
                    <input type="text" id="price-amount" class="w-full p-2 border rounded" placeholder="Price (e.g., 1200 LKR)" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Save</button>
                        <button type="button" id="price-form-reset" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-50">Clear</button>
                    </div>
                    <p id="price-form-message" class="md:col-span-2 lg:col-span-1 text-sm font-medium"></p>
                    <input type="hidden" id="price-entry-id">
                </form>

                <div id="price-matrix-empty" class="hidden text-center text-gray-500 py-6">No price entries yet. Add your first fare preset above.</div>
                <div class="overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-500">
                            <tr>
                                <th class="px-4 py-3 text-left">Origin</th>
                                <th class="px-4 py-3 text-left">Destination</th>
                                <th class="px-4 py-3 text-left">Price</th>
                                <th class="px-4 py-3 text-left">Last Updated</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="price-matrix-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">Price Matrix</h2>
                        <p class="text-sm text-gray-500">Maintain reusable fare presets and departure locations for quick bus creation.</p>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="inline-flex items-center justify-center w-2.5 h-2.5 rounded-full bg-green-500"></span>
                        <span>Updates sync instantly with all admin and timekeeper tools.</span>
                    </div>
                </div>

                <form id="price-matrix-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    <input list="location-options" type="text" id="price-origin" class="w-full p-2 border rounded" placeholder="Origin (e.g., Makumbura)" required>
                    <input list="location-options" type="text" id="price-destination" class="w-full p-2 border rounded" placeholder="Destination (e.g., Galle)" required>
                    <input type="text" id="price-amount" class="w-full p-2 border rounded" placeholder="Price (e.g., 1200 LKR)" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Save</button>
                        <button type="button" id="price-form-reset" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-50">Clear</button>
                    </div>
                    <p id="price-form-message" class="md:col-span-2 lg:col-span-1 text-sm font-medium"></p>
                    <input type="hidden" id="price-entry-id">
                </form>

                <div id="price-matrix-empty" class="hidden text-center text-gray-500 py-6">No price entries yet. Add your first fare preset above.</div>
                <div class="overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-500">
                            <tr>
                                <th class="px-4 py-3 text-left">Origin</th>
                                <th class="px-4 py-3 text-left">Destination</th>
                                <th class="px-4 py-3 text-left">Price</th>
                                <th class="px-4 py-3 text-left">Last Updated</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="price-matrix-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">Price Matrix</h2>
                        <p class="text-sm text-gray-500">Maintain reusable fare presets and departure locations for quick bus creation.</p>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="inline-flex items-center justify-center w-2.5 h-2.5 rounded-full bg-green-500"></span>
                        <span>Updates sync instantly with all admin and timekeeper tools.</span>
                    </div>
                </div>

                <form id="price-matrix-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    <input list="location-options" type="text" id="price-origin" class="w-full p-2 border rounded" placeholder="Origin (e.g., Makumbura)" required>
                    <input list="location-options" type="text" id="price-destination" class="w-full p-2 border rounded" placeholder="Destination (e.g., Galle)" required>
                    <input type="text" id="price-amount" class="w-full p-2 border rounded" placeholder="Price (e.g., 1200 LKR)" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Save</button>
                        <button type="button" id="price-form-reset" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-50">Clear</button>
                    </div>
                    <p id="price-form-message" class="md:col-span-2 lg:col-span-1 text-sm font-medium"></p>
                    <input type="hidden" id="price-entry-id">
                </form>

                <div id="price-matrix-empty" class="hidden text-center text-gray-500 py-6">No price entries yet. Add your first fare preset above.</div>
                <div class="overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-500">
                            <tr>
                                <th class="px-4 py-3 text-left">Origin</th>
                                <th class="px-4 py-3 text-left">Destination</th>
                                <th class="px-4 py-3 text-left">Price</th>
                                <th class="px-4 py-3 text-left">Last Updated</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="price-matrix-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">Price Matrix</h2>
                        <p class="text-sm text-gray-500">Maintain reusable fare presets and departure locations for quick bus creation.</p>
                    </div>
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                        <span class="inline-flex items-center justify-center w-2.5 h-2.5 rounded-full bg-green-500"></span>
                        <span>Updates sync instantly with all admin and timekeeper tools.</span>
                    </div>
                </div>

                <form id="price-matrix-form" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                    <input list="location-options" type="text" id="price-origin" class="w-full p-2 border rounded" placeholder="Origin (e.g., Makumbura)" required>
                    <input list="location-options" type="text" id="price-destination" class="w-full p-2 border rounded" placeholder="Destination (e.g., Galle)" required>
                    <input type="text" id="price-amount" class="w-full p-2 border rounded" placeholder="Price (e.g., 1200 LKR)" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700">Save</button>
                        <button type="button" id="price-form-reset" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-50">Clear</button>
                    </div>
                    <p id="price-form-message" class="md:col-span-2 lg:col-span-1 text-sm font-medium"></p>
                    <input type="hidden" id="price-entry-id">
                </form>

                <div id="price-matrix-empty" class="hidden text-center text-gray-500 py-6">No price entries yet. Add your first fare preset above.</div>
                <div class="overflow-x-auto mt-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-500">
                            <tr>
                                <th class="px-4 py-3 text-left">Origin</th>
                                <th class="px-4 py-3 text-left">Destination</th>
                                <th class="px-4 py-3 text-left">Price</th>
                                <th class="px-4 py-3 text-left">Last Updated</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="price-matrix-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Timetable</h3>
                    <span id="last-updated" class="text-sm text-gray-500"></span>
                </div>
                <div id="loading" class="text-center py-10">Loading timetable...</div>
                <div id="bus-list-container" class="overflow-x-auto hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departure</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Arrival</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Days</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bus-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <p id="bus-empty-state" class="hidden text-center text-gray-500 py-6">No buses in the timetable yet.</p>
            </div>

            <section class="mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
                        <div>
                            <h3 class="text-xl font-semibold">Price Matrix & Destinations</h3>
                            <p class="text-gray-600 text-sm">Maintain official destinations and fare presets. New entries instantly power autocomplete fields.</p>
                        </div>
                        <button id="refresh-matrix" class="self-start md:self-auto bg-slate-100 text-slate-700 px-4 py-2 rounded-md hover:bg-slate-200">Refresh Matrix</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-semibold mb-2">Destinations</h4>
                                <form id="location-form" class="flex gap-2">
                                    <input type="text" id="location-name" placeholder="Add new destination" class="flex-1 p-2 border rounded" required>
                                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Add</button>
                                </form>
                                <p id="location-message" class="text-sm mt-2"></p>
                            </div>
                            <div id="location-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-md divide-y"></div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-semibold mb-2">Quick Fare Entry</h4>
                                <form id="fare-form" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <input type="text" id="fare-origin" list="locations-list" placeholder="Origin" class="p-2 border rounded" required>
                                    <input type="text" id="fare-destination" list="locations-list" placeholder="Destination" class="p-2 border rounded" required>
                                    <input type="text" id="fare-price" placeholder="Price (e.g., 1200 LKR)" class="p-2 border rounded" required>
                                    <button type="submit" class="md:col-span-3 bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Save Fare</button>
                                </form>
                                <p id="fare-message" class="text-sm mt-2"></p>
                            </div>
                            <div class="border border-gray-200 rounded-md overflow-hidden">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-gray-50 text-gray-600 uppercase tracking-wide text-xs">
                                        <tr>
                                            <th class="px-3 py-2 text-left">Origin</th>
                                            <th class="px-3 py-2 text-left">Destination</th>
                                            <th class="px-3 py-2 text-left">Price</th>
                                            <th class="px-3 py-2 text-right">Updated</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fare-table" class="divide-y"></tbody>
                                </table>
                                <p id="fare-empty" class="hidden text-sm text-gray-500 text-center py-4">No fares yet. Add your first pairing above.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <datalist id="location-options"></datalist>

    <!-- Add/Edit Modal -->
    <div id="bus-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3">
                <p id="modal-title" class="text-2xl font-bold">Add New Bus</p>
                <button id="close-modal" class="cursor-pointer z-50">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                </button>
            </div>
            <form id="bus-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" placeholder="Route (e.g., EX1/01)" id="route" class="w-full p-2 border rounded" required>
                    <input type="text" placeholder="Operator" id="operator" class="w-full p-2 border rounded" required>
                    <input type="text" placeholder="Departs From" id="departsFrom" class="w-full p-2 border rounded" list="location-options" required>
                    <input type="text" placeholder="Arrives At" id="arrivesAt" class="w-full p-2 border rounded" list="location-options" required>
                    <input type="time" placeholder="Departure Time" id="departureTime" class="w-full p-2 border rounded" required>
                    <input type="time" placeholder="Arrival Time" id="arrivalTime" class="w-full p-2 border rounded">
                    <input type="text" placeholder="Price (e.g., 1200 LKR)" id="price" class="w-full p-2 border rounded">
                    <input type="text" placeholder="Expressway Entrance" id="expresswayEntrance" class="w-full p-2 border rounded">
                    <input type="text" placeholder="Expressway Exit" id="expresswayExit" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="font-bold">Availability (Days of the Week)</label>
                    <div id="availability-checkboxes" class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2"></div>
                </div>
                <div>
                    <label class="font-bold">Intermediate Stops (one per line)</label>
                    <textarea id="stops" rows="4" class="w-full p-2 border rounded mt-2"></textarea>
                </div>
                <input type="hidden" id="bus-id">
                <div class="flex justify-between items-center">
                    <p id="form-error" class="text-sm text-red-500"></p>
                    <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Save Bus</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bulk-add-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold">Bulk Add Buses by Frequency</p>
                <button id="close-bulk-modal" class="cursor-pointer z-50">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                </button>
            </div>
            <form id="bulk-bus-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" placeholder="Route (e.g., EX1)" id="bulk-route" class="w-full p-2 border rounded" required>
                    <input type="text" placeholder="Operator" id="bulk-operator" class="w-full p-2 border rounded" required>
                    <input type="text" placeholder="Departs From" id="bulk-departsFrom" class="w-full p-2 border rounded" list="location-options" required>
                    <input type="text" placeholder="Arrives At" id="bulk-arrivesAt" class="w-full p-2 border rounded" list="location-options" required>
                    <input type="text" placeholder="Price" id="bulk-price" class="w-full p-2 border rounded">
                    <input type="text" placeholder="Expressway Entrance" id="bulk-expresswayEntrance" class="w-full p-2 border rounded">
                    <input type="text" placeholder="Expressway Exit" id="bulk-expresswayExit" class="w-full p-2 border rounded">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-md">
                    <div>
                        <label for="bulk-startTime" class="font-semibold block text-sm">Start Time</label>
                        <input type="time" id="bulk-startTime" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label for="bulk-endTime" class="font-semibold block text-sm">End Time</label>
                        <input type="time" id="bulk-endTime" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label for="bulk-frequency" class="font-semibold block text-sm">Frequency (mins)</label>
                        <input type="number" id="bulk-frequency" class="w-full p-2 border rounded" placeholder="e.g., 30" required>
                    </div>
                    <div>
                        <label for="bulk-duration" class="font-semibold block text-sm">Travel Duration (mins)</label>
                        <input type="number" id="bulk-duration" class="w-full p-2 border rounded" placeholder="e.g., 90" required>
                    </div>
                </div>
                <div>
                    <label class="font-bold">Availability (Days of the Week)</label>
                    <div id="bulk-availability-checkboxes" class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2"></div>
                </div>
                <div>
                    <label class="font-bold">Intermediate Stops (one per line)</label>
                    <textarea id="bulk-stops" rows="3" class="w-full p-2 border rounded mt-2"></textarea>
                </div>
                <p id="bulk-add-message" class="text-sm font-medium"></p>
                <button type="submit" class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600">Generate and Add Buses</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { getApp, getApps, initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import {
            getFirestore,
            addDoc,
            collection,
            deleteDoc,
            doc,
            getDoc,
            getDocs,
            limit,
            onSnapshot,
            orderBy,
            query,
            serverTimestamp,
            setDoc,
            updateDoc,
            where,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // This is the correct format. Just paste your values here.
        // --- Firebase bootstrap -------------------------------------------------
        // Paste your Firebase console configuration below. Only change the values
        // on the right-hand side so the modular SDK imports continue to work.
        const firebaseConfig = {
        apiKey: "AIzaSyArXmYmU6l4t_xaNquhT0JUH4sG2ge3tZo",
        authDomain: "bustimetable-v2.firebaseapp.com",
        projectId: "bustimetable-v2",
        storageBucket: "bustimetable-v2.firebasestorage.app",
        messagingSenderId: "665985152111",
        appId: "1:665985152111:web:291020ebb619374c4f899a",
        measurementId: "G-0EEKT7RR6R"
        };

        // --- SCRIPT INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Abort early and surface a friendly message if a developer forgets to
            // populate the Firebase configuration. This keeps the UI from failing
            // silently when testing on a fresh clone of the repository.
            if (!firebaseConfig.apiKey) {
                document.getElementById('config-warning').classList.remove('hidden');
                return;
            }
        })

            // Re-use any existing Firebase app (important for live-reload flows)
            // or create a new one when the admin dashboard boots for the first time.
            const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // DOM Elements
            const loginScreen = document.getElementById('login-screen');
            const dashboard = document.getElementById('dashboard');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout-button');
            const busListContainer = document.getElementById('bus-list-container');
            const busTableBody = document.getElementById('bus-table-body');
            const busEmptyState = document.getElementById('bus-empty-state');
            const lastUpdatedLabel = document.getElementById('last-updated');
            const loading = document.getElementById('loading');

            const busModal = document.getElementById('bus-modal');
            const modalTitle = document.getElementById('modal-title');
            const closeModal = document.getElementById('close-modal');
            const showAddModal = document.getElementById('show-add-modal');
            const busForm = document.getElementById('bus-form');
            
            const bulkAddModal = document.getElementById('bulk-add-modal');
            const showBulkAddModal = document.getElementById('show-bulk-add-modal');
            const closeBulkModal = document.getElementById('close-bulk-modal');
            const bulkBusForm = document.getElementById('bulk-bus-form');
            const bulkAddMessage = document.getElementById('bulk-add-message');

            const priceForm = document.getElementById('price-matrix-form');
            const priceOriginInput = document.getElementById('price-origin');
            const priceDestinationInput = document.getElementById('price-destination');
            const priceAmountInput = document.getElementById('price-amount');
            const priceEntryIdInput = document.getElementById('price-entry-id');
            const priceFormMessage = document.getElementById('price-form-message');
            const priceFormReset = document.getElementById('price-form-reset');
            const priceMatrixBody = document.getElementById('price-matrix-body');
            const priceMatrixEmpty = document.getElementById('price-matrix-empty');
            const locationOptionsList = document.getElementById('location-options');

            const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

            let currentUser = null;
            let unsubscribe = null;
            let priceMatrixUnsubscribe = null;
            let priceAutoFillRegistered = false;

            const state = {
                buses: [],
                sortable: null
            };

            const priceLookup = new Map();
            const priceEntryByKey = new Map();
            const locationSet = new Set();

            function normalizeRole(role) {
                const value = (role || '').toString().trim().toLowerCase();
                if (value === 'administrator') return 'admin';
                if (value === 'timekeepers') return 'timekeeper';
                return value;
            }

            function extractRoleFromClaims(claims, allowedRoles) {
                if (!claims) return '';
                const sources = [
                    claims.role,
                    claims.userRole,
                    claims.customRole,
                    ...(Array.isArray(claims.roles) ? claims.roles : []),
                    ...(Array.isArray(claims.permissions) ? claims.permissions : [])
                ];
                for (const entry of sources) {
                    const normalized = normalizeRole(entry);
                    if (!normalized) continue;
                    if (!allowedRoles.length || allowedRoles.includes(normalized)) {
                        return normalized;
                    }
                }
                return '';
            }

            async function maybeBackfillEmailLower(usersCollection, profile, emailLower) {
                if (!profile || !profile.id || !emailLower) return profile;
                if ((profile.emailLower || '').toString().toLowerCase() === emailLower) {
                    return profile;
                }
                try {
                    await setDoc(doc(usersCollection, profile.id), { emailLower }, { merge: true });
                    profile.emailLower = emailLower;
                } catch (error) {
                    console.warn('Unable to backfill lowercase email for user profile:', error);
                }
                return profile;
            }

            async function ensureProfileFromClaims(user, role) {
                if (!user) return;
                const usersCollection = collection(db, 'users');
                const email = (user.email || '').trim();
                const payload = {
                    role,
                    email,
                    emailLower: email.toLowerCase(),
                    displayName: user.displayName || '',
                    syncedFromClaims: true,
                    updatedAt: serverTimestamp()
                };
                try {
                    await setDoc(doc(usersCollection, user.uid), payload, { merge: true });
                } catch (error) {
                    console.warn('Unable to seed Firestore profile from custom claims:', error);
                }
            }

            async function resolveRole(user, allowedRoles) {
                const profile = await fetchUserProfile(user);
                const profileRole = normalizeRole(profile?.role);
                if (profileRole && (!allowedRoles.length || allowedRoles.includes(profileRole))) {
                    return { role: profileRole, profile };
                }

                try {
                    const token = await user.getIdTokenResult(true);
                    const claimRole = extractRoleFromClaims(token?.claims, allowedRoles);
                    if (claimRole) {
                        await ensureProfileFromClaims(user, claimRole);
                        const refreshedProfile = profile || await fetchUserProfile(user);
                        return { role: claimRole, profile: refreshedProfile || profile };
                    }
                } catch (error) {
                    console.warn('Unable to resolve role from custom claims:', error);
                }

                return { role: profileRole || null, profile };
            }

            async function fetchUserProfile(user) {
                if (!user) return null;
                const email = (user.email || '').trim();
                const emailLower = email.toLowerCase();

                const usersCollection = collection(db, 'users');

                const tryDoc = async (docId) => {
                    if (!docId) return null;
                    const docRef = doc(usersCollection, docId);
                    const docSnap = await getDoc(docRef);
                    return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
                };

                try {
                    let profile = await tryDoc(user.uid);
                    if (profile) return maybeBackfillEmailLower(usersCollection, profile, emailLower);

                    profile = await tryDoc(email);
                    if (profile) return maybeBackfillEmailLower(usersCollection, profile, emailLower);

                    if (emailLower !== email) {
                        profile = await tryDoc(emailLower);
                        if (profile) return maybeBackfillEmailLower(usersCollection, profile, emailLower);
                    }

                    if (email) {
                        let snapshot = await getDocs(query(usersCollection, where('emailLower', '==', emailLower), limit(1)));
                        if (!snapshot.empty) {
                            const docSnap = snapshot.docs[0];
                            return maybeBackfillEmailLower(usersCollection, { id: docSnap.id, ...docSnap.data() }, emailLower);
                        }

                        snapshot = await getDocs(query(usersCollection, where('email', '==', email), limit(1)));
                        if (!snapshot.empty) {
                            const docSnap = snapshot.docs[0];
                            return maybeBackfillEmailLower(usersCollection, { id: docSnap.id, ...docSnap.data() }, emailLower);
                        }
                    }

                    return null;
                } catch (error) {
                    console.error('Error fetching user profile:', error);
                    throw error;
                }
            }

            // --- AUTHENTICATION & ACCESS CONTROL ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const { role } = await resolveRole(user, ['admin']);
                        if (role === 'admin') {
                            currentUser = user;
                            loginScreen.classList.add('hidden');
                            dashboard.classList.remove('hidden');
                            loadBuses();
                            startPriceMatrixListener();
                        } else {
                            alert('Access Denied. You must be an administrator to view this page.');
                            await signOut(auth);
                        }
                    } catch (error) {
                        alert('Unable to verify your permissions. Please try again or contact support.');
                        await signOut(auth);
                    }
                } else {
                    currentUser = null;
                    loginScreen.classList.remove('hidden');
                    dashboard.classList.add('hidden');
                    if (unsubscribe) unsubscribe();
                    if (priceMatrixUnsubscribe) priceMatrixUnsubscribe();
                    clearPriceMatrixState();
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    document.getElementById('login-error').textContent = '';
                } catch (error) {
                    document.getElementById('login-error').textContent = error.message;
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error('Failed to sign out:', error);
                }
            });

            // --- DATA HANDLING ---
            function clearPriceMatrixState() {
                priceLookup.clear();
                locationSet.clear();
                updateLocationOptions();
                renderPriceMatrix([]);
                priceFormMessage.textContent = '';
                priceFormMessage.className = 'md:col-span-2 lg:col-span-1 text-sm font-medium';
                priceEntryIdInput.value = '';
                priceAutoFillRegistered = false;
            }

            function startPriceMatrixListener() {
                if (priceMatrixUnsubscribe) priceMatrixUnsubscribe();
                const priceMatrixQuery = query(collection(db, 'priceMatrix'), orderBy('origin'));
                priceMatrixUnsubscribe = onSnapshot(priceMatrixQuery, snapshot => {
                    const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    refreshPriceMatrix(entries);
                }, error => {
                    console.error('Error loading price matrix:', error);
                    priceFormMessage.textContent = 'Unable to load price matrix. Check console logs.';
                    priceFormMessage.className = 'md:col-span-2 lg:col-span-1 text-sm font-medium text-red-600';
                });
            }

            function refreshPriceMatrix(entries) {
                priceLookup.clear();
                priceEntryByKey.clear();
                locationSet.clear();
                entries.forEach(entry => {
                    const origin = (entry.origin || '').trim();
                    const destination = (entry.destination || '').trim();
                    if (!origin || !destination) return;
                    locationSet.add(origin);
                    locationSet.add(destination);
                    const key = `${origin.toLowerCase()}__${destination.toLowerCase()}`;
                    priceLookup.set(key, entry.price || '');
                    priceEntryByKey.set(key, entry.id);
                });
                updateLocationOptions();
                renderPriceMatrix(entries);
                autoFillPriceFields();
            }

            function updateLocationOptions() {
                if (!locationOptionsList) return;
                locationOptionsList.innerHTML = '';
                Array.from(locationSet).sort((a, b) => a.localeCompare(b)).forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    locationOptionsList.appendChild(option);
                });
            }

            function renderPriceMatrix(entries) {
                priceMatrixBody.innerHTML = '';
                if (!entries.length) {
                    priceMatrixEmpty.classList.remove('hidden');
                    return;
                }
                priceMatrixEmpty.classList.add('hidden');
                entries.forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = entry.id;
                    tr.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-800">${entry.origin}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-gray-700">${entry.destination}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-indigo-600 font-semibold">${entry.price || ''}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">${entry.updatedAt ? new Date(entry.updatedAt.seconds ? entry.updatedAt.seconds * 1000 : entry.updatedAt).toLocaleString() : ''}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button class="text-indigo-600 hover:text-indigo-900 price-edit" data-id="${entry.id}">Edit</button>
                            <button class="text-red-600 hover:text-red-900 price-delete ml-4" data-id="${entry.id}">Delete</button>
                        </td>`;
                    priceMatrixBody.appendChild(tr);
                });
            }

            function autoFillPriceFields() {
                if (priceAutoFillRegistered) return;
                const pricePairs = [
                    {
                        origin: document.getElementById('departsFrom'),
                        destination: document.getElementById('arrivesAt'),
                        price: document.getElementById('price')
                    },
                    {
                        origin: document.getElementById('bulk-departsFrom'),
                        destination: document.getElementById('bulk-arrivesAt'),
                        price: document.getElementById('bulk-price')
                    }
                ].filter(pair => pair.origin && pair.destination && pair.price);

                pricePairs.forEach(pair => {
                    if (!pair.price.dataset) pair.price.dataset = {};
                    pair.price.addEventListener('input', () => {
                        pair.price.dataset.autofilled = 'false';
                    });
                    ['change', 'blur'].forEach(evt => {
                        pair.origin.addEventListener(evt, () => maybeFillPrice(pair));
                        pair.destination.addEventListener(evt, () => maybeFillPrice(pair));
                    });
                });
                priceAutoFillRegistered = true;
            }

            function maybeFillPrice({ origin, destination, price }) {
                const originVal = origin.value.trim();
                const destinationVal = destination.value.trim();
                if (!originVal || !destinationVal) return;
                const key = `${originVal.toLowerCase()}__${destinationVal.toLowerCase()}`;
                if (!priceLookup.has(key)) return;
                if (!price.value.trim() || price.dataset.autofilled === 'true') {
                    price.value = priceLookup.get(key);
                    price.dataset.autofilled = 'true';
                }
            }

            if (priceForm) {
                priceForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const origin = priceOriginInput.value.trim();
                    const destination = priceDestinationInput.value.trim();
                    const priceValue = priceAmountInput.value.trim();

                    if (!origin || !destination || !priceValue) {
                        priceFormMessage.textContent = 'Please complete all fields.';
                        priceFormMessage.className = 'md:col-span-2 lg:col-span-1 text-sm font-medium text-red-600';
                        return;
                    }

                    const payload = {
                        origin,
                        destination,
                        price: priceValue,
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUser ? currentUser.uid : null
                    };

                    try {
                        if (priceEntryIdInput.value) {
                            await setDoc(doc(db, 'priceMatrix', priceEntryIdInput.value), payload, { merge: true });
                            priceFormMessage.textContent = 'Price entry updated.';
                        } else {
                            const key = `${origin.toLowerCase()}__${destination.toLowerCase()}`;
                            const existingId = priceEntryByKey.get(key);
                            if (existingId) {
                                await setDoc(doc(db, 'priceMatrix', existingId), payload, { merge: true });
                                priceFormMessage.textContent = 'Existing price updated.';
                            } else {
                                await addDoc(collection(db, 'priceMatrix'), payload);
                                priceFormMessage.textContent = 'Price entry saved.';
                            }
                        }
                        priceFormMessage.className = 'md:col-span-2 lg:col-span-1 text-sm font-medium text-green-600';
                        priceForm.reset();
                        priceEntryIdInput.value = '';
                        priceAmountInput.dataset.autofilled = 'false';
                    } catch (error) {
                        console.error('Error saving price entry:', error);
                        priceFormMessage.textContent = 'Failed to save price entry. Try again.';
                        priceFormMessage.className = 'md:col-span-2 lg:col-span-1 text-sm font-medium text-red-600';
                    }
                });

                priceFormReset.addEventListener('click', () => {
                    priceForm.reset();
                    priceEntryIdInput.value = '';
                    priceFormMessage.textContent = '';
                    priceFormMessage.className = 'md:col-span-2 lg:col-span-1 text-sm font-medium';
                });

                priceMatrixBody.addEventListener('click', async (event) => {
                    const rowId = event.target.dataset.id;
                    if (!rowId) return;

                    if (event.target.classList.contains('price-edit')) {
                        const docRef = doc(db, 'priceMatrix', rowId);
                        const docSnap = await getDoc(docRef);
                        if (!docSnap.exists()) return;
                        const data = docSnap.data();
                        priceOriginInput.value = data.origin || '';
                        priceDestinationInput.value = data.destination || '';
                        priceAmountInput.value = data.price || '';
                        priceEntryIdInput.value = rowId;
                        priceFormMessage.textContent = 'Editing existing entry. Save to update or Clear to cancel.';
                        priceFormMessage.className = 'md:col-span-2 lg:col-span-1 text-sm font-medium text-indigo-600';
                    }

                    if (event.target.classList.contains('price-delete')) {
                        if (confirm('Delete this price entry?')) {
                            await deleteDoc(doc(db, 'priceMatrix', rowId));
                        }
                    }
                });
            }

            function loadBuses() {
                if (unsubscribe) unsubscribe(); // Detach previous listener
                const busesQuery = query(collection(db, 'buses'), orderBy('sortOrder'));
                unsubscribe = onSnapshot(busesQuery, snapshot => {
                    const buses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderBusTable(buses);
                }, error => {
                    console.error('Error fetching buses:', error);
                    if (loading) {
                        loading.textContent = 'Error loading data. Check console.';
                        loading.classList.remove('hidden');
                    }
                });
            }

            function renderBusTable(buses) {
                state.buses = Array.isArray(buses) ? buses : [];

                if (loading) {
                    loading.classList.add('hidden');
                }

                if (!busTableBody) {
                    return;
                }

                busTableBody.innerHTML = '';

                if (!state.buses.length) {
                    if (busListContainer) {
                        busListContainer.classList.add('hidden');
                    }
                    if (busEmptyState) {
                        busEmptyState.classList.remove('hidden');
                    }
                    if (lastUpdatedLabel) {
                        lastUpdatedLabel.textContent = '';
                    }
                } else {
                    state.buses.forEach((bus, index) => {
                        const tr = document.createElement('tr');
                        tr.dataset.id = bus.id;
                        tr.innerHTML = `
                            <td class="px-4 py-3 text-sm text-gray-500 font-medium cursor-move">${index + 1}</td>
                            <td class="px-4 py-3">
                                <div class="font-semibold text-gray-800">${bus.route || ''}</div>
                                <div class="text-sm text-gray-500">${bus.operator || ''}</div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">
                                <div class="font-medium">${bus.departsFrom || ''}</div>
                                <div class="text-xs text-gray-500">${bus.departureTime || ''}</div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">
                                <div class="font-medium">${bus.arrivesAt || ''}</div>
                                <div class="text-xs text-gray-500">${bus.arrivalTime || ''}</div>
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-600">${Array.isArray(bus.availability) ? bus.availability.join(', ') : ''}</td>
                            <td class="px-4 py-3 text-sm">${renderStatusPill(bus.status)}</td>
                            <td class="px-4 py-3 text-right text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 edit-btn" data-id="${bus.id}">Edit</button>
                                <button class="text-red-600 hover:text-red-900 ml-4 delete-btn" data-id="${bus.id}">Delete</button>
                            </td>`;
                        busTableBody.appendChild(tr);
                    });

                    if (busListContainer) {
                        busListContainer.classList.remove('hidden');
                    }
                    if (busEmptyState) {
                        busEmptyState.classList.add('hidden');
                    }
                    if (lastUpdatedLabel) {
                        lastUpdatedLabel.textContent = `Last updated ${new Date().toLocaleString()}`;
                    }
                }

                if (state.sortable) {
                    state.sortable.destroy();
                    state.sortable = null;
                }

                if (state.buses.length && busTableBody) {
                    state.sortable = new Sortable(busTableBody, {
                        animation: 150,
                        handle: 'td:first-child',
                        ghostClass: 'sortable-ghost',
                        onEnd: handleReorder
                    });
                }
            }

            busListContainer.addEventListener('click', async (e) => {
                const busId = e.target.dataset.id;
                if (e.target.classList.contains('edit-btn')) {
                    const docRef = doc(db, 'buses', busId);
                    const docSnap = await getDoc(docRef);
                    openModal('Edit Bus', docSnap.data(), busId);
                }
                if (e.target.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this bus?')) {
                        await deleteDoc(doc(db, 'buses', busId));
                    }
                }
            });

        function renderStatusPill(status) {
            const map = {
                'Scheduled': 'bg-gray-100 text-gray-700',
                'Departed': 'bg-green-100 text-green-700',
                'Arrived': 'bg-blue-100 text-blue-700',
                'Delayed': 'bg-yellow-100 text-yellow-700',
                'Cancelled': 'bg-red-100 text-red-700'
            };
            const classes = map[status] || map['Scheduled'];
            return `<span class="px-2 py-1 rounded-full ${classes}">${status || 'Scheduled'}</span>`;
        }

        async function handleReorder() {
            const orderedIds = Array.from(busTableBody.querySelectorAll('tr')).map(row => Number(row.dataset.id));
            try {
                const response = await fetchWithAuth('/api/buses/order', {
                    method: 'POST',
                    body: JSON.stringify({ orderedIds })
                });
                if (!response.ok) throw new Error('Failed to update order');
            } catch (error) {
                console.error('Reorder failed', error);
                alert('Unable to save the new order. Please refresh.');
                loadBuses();
            }
        }

        async function handleBusSubmit(event) {
            event.preventDefault();
            formError.textContent = '';
            const payload = collectBusFormData();
            if (!payload) return;

            const busId = busIdInput.value;
            const method = busId ? 'PUT' : 'POST';
            const url = busId ? `/api/buses/${busId}` : '/api/buses';
            try {
                const response = await fetchWithAuth(url, {
                    method,
                    body: JSON.stringify(payload)
                });
            };
            
            setupCheckboxes('availability-checkboxes');
            setupCheckboxes('bulk-availability-checkboxes');

            showAddModal.addEventListener('click', () => openModal('Add New Bus'));
            closeModal.addEventListener('click', () => busModal.classList.add('hidden'));
            
            busForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const busId = busForm['bus-id'].value;
                const stops = busForm.stops.value.split('\n').map(s => s.trim()).filter(Boolean);
                const availability = Array.from(document.querySelectorAll('#availability-checkboxes input:checked'))
                                       .map(cb => cb.value).filter(v => daysOfWeek.includes(v));

                const busData = {
                    route: busForm.route.value,
                    operator: busForm.operator.value,
                    departsFrom: busForm.departsFrom.value,
                    arrivesAt: busForm.arrivesAt.value,
                    departureTime: busForm.departureTime.value,
                    arrivalTime: busForm.arrivalTime.value,
                    price: busForm.price.value,
                    expresswayEntrance: busForm.expresswayEntrance.value,
                    expresswayExit: busForm.expresswayExit.value,
                    stops,
                    availability
                };

                if (busId) {
                    await updateDoc(doc(db, 'buses', busId), busData);
                } else {
                    const latestSnapshot = await getDocs(query(collection(db, 'buses'), orderBy('sortOrder', 'desc'), limit(1)));
                    const maxOrder = latestSnapshot.empty ? -1 : latestSnapshot.docs[0].data().sortOrder;
                    busData.sortOrder = maxOrder + 1;
                    busData.status = 'Scheduled'; // Default status for new buses
                    await addDoc(collection(db, 'buses'), busData);
                }
            });
            if (!valid) {
                formError.textContent = 'Please fill in all required fields.';
                return null;
            }
            payload.availability = getSelectedDays(availabilityContainer);
            payload.stops = stopsTextarea.value
                .split(/
?
/)
                .map(line => line.trim())
                .filter(Boolean);
            return payload;
        }

        async function handleDelete(event) {
            const id = event.target.dataset.id;
            if (!id) return;
            if (!confirm('Are you sure you want to delete this bus?')) return;
            try {
                const response = await fetchWithAuth(`/api/buses/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete bus');
                await loadBuses();
            } catch (error) {
                alert(error.message);
            }
        }

        function handleEdit(event) {
            const id = Number(event.target.dataset.id);
            if (!id) return;
            const bus = state.buses.find(item => item.id === id);
            if (bus) openBusModal(bus);
        }

        async function handleBulkSubmit(event) {
            event.preventDefault();
            bulkMessage.textContent = '';
            const availability = getSelectedDays(bulkAvailabilityContainer);
            const stops = bulkStopsTextarea.value.split(/
?
/).map(line => line.trim()).filter(Boolean);

            const route = document.getElementById('bulk-route').value.trim();
            const operator = document.getElementById('bulk-operator').value.trim();
            const departsFrom = document.getElementById('bulk-departsFrom').value.trim();
            const arrivesAt = document.getElementById('bulk-arrivesAt').value.trim();
            const price = document.getElementById('bulk-price').value.trim();
            const expresswayEntrance = document.getElementById('bulk-expresswayEntrance').value.trim();
            const expresswayExit = document.getElementById('bulk-expresswayExit').value.trim();
            const startTime = document.getElementById('bulk-startTime').value;
            const endTime = document.getElementById('bulk-endTime').value;
            const frequency = Number(document.getElementById('bulk-frequency').value);
            const duration = Number(document.getElementById('bulk-duration').value);

            if (!route || !operator || !departsFrom || !arrivesAt || !startTime || !endTime || !frequency || frequency <= 0) {
                bulkMessage.textContent = 'Please fill in all required fields with valid values.';
                bulkMessage.className = 'text-sm font-medium text-red-600';
                return;
            }

            const departures = generateDepartures(startTime, endTime, frequency);
            if (departures.length === 0) {
                bulkMessage.textContent = 'No departures generated. Check your start/end times and frequency.';
                bulkMessage.className = 'text-sm font-medium text-red-600';
                return;
            }

            try {
                for (const departure of departures) {
                    const payload = {
                        route,
                        operator,
                        departsFrom,
                        arrivesAt,
                        departureTime: departure,
                        arrivalTime: addMinutes(departure, duration),
                        price,
                        expresswayEntrance,
                        expresswayExit,
                        availability,
                        stops
                    };
                    const routeBase = document.getElementById('bulk-route').value;
                    const startTime = document.getElementById('bulk-startTime').value;
                    const endTime = document.getElementById('bulk-endTime').value;
                    const frequency = parseInt(document.getElementById('bulk-frequency').value, 10);
                    const duration = parseInt(document.getElementById('bulk-duration').value, 10);

                    if (!startTime || !endTime || isNaN(frequency) || isNaN(duration) || frequency <= 0) {
                        throw new Error("Please fill in all time and frequency fields correctly.");
                    }
                    
                    const startMinutes = timeToMinutes(startTime);
                    const endMinutes = timeToMinutes(endTime);
                    
                    const batch = writeBatch(db);
                    let busCount = 0;
                    const latestSnapshot = await getDocs(query(collection(db, 'buses'), orderBy('sortOrder', 'desc'), limit(1)));
                    let currentSortOrder = latestSnapshot.empty ? 0 : latestSnapshot.docs[0].data().sortOrder + 1;

                    for (let depMinutes = startMinutes; depMinutes <= endMinutes; depMinutes += frequency) {
                        const arrMinutes = depMinutes + duration;
                        const newBus = {
                            ...commonData,
                            route: `${routeBase}/${String(busCount + 1).padStart(2, '0')}`,
                            departureTime: minutesToTime(depMinutes),
                            arrivalTime: minutesToTime(arrMinutes),
                            sortOrder: currentSortOrder++
                        };
                        const newDocRef = doc(collection(db, 'buses'));
                        batch.set(newDocRef, newBus);
                        busCount++;
                    }
                }
                bulkMessage.textContent = `Added ${departures.length} departures.`;
                bulkMessage.className = 'text-sm font-medium text-green-600';
                await loadBuses();
                closeBulkModal();
            } catch (error) {
                bulkMessage.textContent = error.message;
                bulkMessage.className = 'text-sm font-medium text-red-600';
            }
        }

        function generateDepartures(startTime, endTime, frequency) {
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);
            let currentMinutes = startHour * 60 + startMinute;
            const endMinutes = endHour * 60 + endMinute;
            const departures = [];
            while (currentMinutes <= endMinutes) {
                const hours = String(Math.floor(currentMinutes / 60)).padStart(2, '0');
                const minutes = String(currentMinutes % 60).padStart(2, '0');
                departures.push(`${hours}:${minutes}`);
                currentMinutes += frequency;
            }
            return departures;
        }

        function addMinutes(time, duration) {
            if (!time || !duration) return '';
            const [hours, minutes] = time.split(':').map(Number);
            const total = hours * 60 + minutes + duration;
            const normalized = total % (24 * 60);
            const hh = String(Math.floor(normalized / 60)).padStart(2, '0');
            const mm = String(normalized % 60).padStart(2, '0');
            return `${hh}:${mm}`;
        }

        busTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-btn')) {
                handleEdit(event);
            } else if (event.target.classList.contains('delete-btn')) {
                handleDelete(event);
            }
        });

        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        refreshButton.addEventListener('click', loadBuses);
        showAddModalButton.addEventListener('click', () => openBusModal());
        closeModalButton.addEventListener('click', closeBusModal);
        busModal.addEventListener('click', (event) => { if (event.target === busModal) closeBusModal(); });
        busForm.addEventListener('submit', handleBusSubmit);

        showBulkModalButton.addEventListener('click', openBulkModal);
        closeBulkModalButton.addEventListener('click', closeBulkModal);
        bulkModal.addEventListener('click', (event) => { if (event.target === bulkModal) closeBulkModal(); });
        bulkForm.addEventListener('submit', handleBulkSubmit);

        renderAvailabilityCheckboxes(availabilityContainer);
        renderAvailabilityCheckboxes(bulkAvailabilityContainer);
        toggleView();
    </script>
</body>
</html>
