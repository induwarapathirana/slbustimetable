<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Bus Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        .ghost { opacity: 0.4; background: #c8ebfb; }
        .sortable-chosen { cursor: grabbing; }
        #config-warning {
            display: none;
            background-color: #fffbe6;
            color: #92400e;
            padding: 1rem;
            border: 1px solid #fde68a;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Admin Login</h2>
            <div id="config-warning">
                <strong>Configuration Needed:</strong> Please paste your Firebase config object into the HTML file to enable the login form.
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" id="login-button" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition duration-300">Login</button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
        </div>
    </div>

    <!-- Main Admin Dashboard (hidden by default) -->
    <div id="admin-dashboard" class="hidden">
        <header class="bg-white shadow-md">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Bus Timetable Dashboard</h1>
                <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition">Logout</button>
            </nav>
        </header>

        <main class="container mx-auto p-6">
            <!-- Add Bus Form -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Add New Bus Route</h2>
                <form id="add-bus-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Form fields -->
                    <input type="text" id="add-route" placeholder="Route Name (e.g., 100)" class="px-3 py-2 border rounded" required>
                    <input type="text" id="add-operator" placeholder="Operator (e.g., City Bus)" class="px-3 py-2 border rounded" required>
                    <input type="text" id="add-departsFrom" placeholder="Departs From" class="px-3 py-2 border rounded" required>
                    <input type="text" id="add-arrivesAt" placeholder="Arrives At" class="px-3 py-2 border rounded" required>
                    <input type="time" id="add-departureTime" class="px-3 py-2 border rounded" required>
                    <input type="time" id="add-arrivalTime" class="px-3 py-2 border rounded" required>
                    <input type="text" id="add-price" placeholder="Price (e.g., Â£5.50)" class="px-3 py-2 border rounded">
                    <textarea id="add-stops" placeholder="Mid-stops (comma-separated)" class="md:col-span-2 px-3 py-2 border rounded"></textarea>
                    
                    <div class="lg:col-span-3">
                        <label class="block text-gray-700 mb-2 font-medium">Availability:</label>
                        <div id="add-availability" class="flex flex-wrap gap-4 items-center">
                            <!-- Checkboxes will be inserted here by JS -->
                        </div>
                    </div>

                    <div class="lg:col-span-3">
                        <button type="submit" class="w-full md:w-auto bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition">Add Bus</button>
                    </div>
                </form>
            </div>

            <!-- Bus Timetable List -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Current Timetable</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-3">Route</th>
                                <th class="p-3">From</th>
                                <th class="p-3">To</th>
                                <th class="p-3">Departure</th>
                                <th class="p-3">Arrival</th>
                                <th class="p-3">Availability</th>
                                <th class="p-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bus-list" class="divide-y">
                            <!-- Bus rows will be populated here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl">
            <h2 class="text-xl font-semibold mb-6">Edit Bus Route</h2>
            <form id="edit-bus-form">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="text" id="edit-route" placeholder="Route" class="px-3 py-2 border rounded" required>
                    <input type="text" id="edit-operator" placeholder="Operator" class="px-3 py-2 border rounded" required>
                    <input type="text" id="edit-departsFrom" placeholder="Departs From" class="px-3 py-2 border rounded" required>
                    <input type="text" id="edit-arrivesAt" placeholder="Arrives At" class="px-3 py-2 border rounded" required>
                    <input type="time" id="edit-departureTime" class="px-3 py-2 border rounded" required>
                    <input type="time" id="edit-arrivalTime" class="px-3 py-2 border rounded" required>
                    <input type="text" id="edit-price" placeholder="Price" class="px-3 py-2 border rounded">
                    <textarea id="edit-stops" placeholder="Stops" class="md:col-span-2 px-3 py-2 border rounded"></textarea>
                    
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 mb-2 font-medium">Availability:</label>
                        <div id="edit-availability" class="flex flex-wrap gap-4 items-center">
                           <!-- Checkboxes will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-edit" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- IMPORTANT: CONFIGURE FIREBASE ---
        // This is the correct format. Just paste your values here.
        const firebaseConfig = {
            apiKey: "AIzaSyATfiFaqfh0leWZMi8pq7OAgb5G7ANBv8o",
            authDomain: "sl-bus-timetable-app.firebaseapp.com",
            projectId: "sl-bus-timetable-app",
            storageBucket: "sl-bus-timetable-app.firebasestorage.app",
            messagingSenderId: "107324674333",
            appId: "1:107324674333:web:2058e8958f2c1dfd0c91f4",
            measurementId: "G-JEBZ0J484N"
        };

        // --- SCRIPT INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const warningDiv = document.getElementById('config-warning');
            const loginButton = document.getElementById('login-button');

            // 1. Check if Firebase config is still a placeholder
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                warningDiv.style.display = 'block';
                loginButton.disabled = true;
                loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                console.error("Firebase config is missing. Please paste it into admin.html.");
                return; // Stop execution if config is missing
            }

            // 2. Initialize Firebase only if config is valid
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const busesCollection = db.collection('buses');

            // 3. Now, run the main application logic
            runAdminApp(auth, db, busesCollection);
        });

        function runAdminApp(auth, db, busesCollection) {
            // DOM Elements
            const loginScreen = document.getElementById('login-screen');
            const adminDashboard = document.getElementById('admin-dashboard');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutButton = document.getElementById('logout-button');
            const busList = document.getElementById('bus-list');
            const addBusForm = document.getElementById('add-bus-form');
            const editModal = document.getElementById('edit-modal');
            const editBusForm = document.getElementById('edit-bus-form');
            const cancelEditButton = document.getElementById('cancel-edit');

            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            // --- AUTHENTICATION LOGIC ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    loginScreen.classList.add('hidden');
                    adminDashboard.classList.remove('hidden');
                    fetchAndDisplayBuses();
                } else {
                    loginScreen.classList.remove('hidden');
                    adminDashboard.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                loginError.textContent = '';
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        loginError.textContent = error.message;
                    });
            });

            logoutButton.addEventListener('click', () => {
                auth.signOut();
            });

            // --- UI HELPER FUNCTIONS ---
            const createDayCheckboxes = (containerId, prefix = '') => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                daysOfWeek.forEach(day => {
                    container.innerHTML += `
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="${prefix}day" value="${day}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span>${day}</span>
                        </label>
                    `;
                });
                container.innerHTML += `
                    <label class="flex items-center space-x-2 font-bold">
                        <input type="checkbox" id="${prefix}select-all-days" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>All Days</span>
                    </label>
                `;
                document.getElementById(`${prefix}select-all-days`).addEventListener('change', (e) => {
                    document.querySelectorAll(`input[name="${prefix}day"]`).forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
            };

            const getSelectedDays = (prefix = '') => {
                const selected = [];
                document.querySelectorAll(`input[name="${prefix}day"]:checked`).forEach(checkbox => {
                    selected.push(checkbox.value);
                });
                return selected;
            };

            // Initialize day checkboxes
            createDayCheckboxes('add-availability', 'add-');
            createDayCheckboxes('edit-availability', 'edit-');

            // --- FIRESTORE CRUD OPERATIONS ---
            let sortableInstance = null;
            
            const fetchAndDisplayBuses = async () => {
                busList.innerHTML = '<tr><td colspan="7" class="text-center p-4">Loading...</td></tr>';
                try {
                    const snapshot = await busesCollection.orderBy('sortOrder').get();
                    if (snapshot.empty) {
                        busList.innerHTML = '<tr><td colspan="7" class="text-center p-4">No bus routes found. Add one above.</td></tr>';
                        return;
                    }
                    
                    busList.innerHTML = '';
                    snapshot.forEach(doc => {
                        const bus = { id: doc.id, ...doc.data() };
                        const row = document.createElement('tr');
                        row.dataset.id = bus.id;
                        row.className = 'hover:bg-gray-50 cursor-move';
                        row.innerHTML = `
                            <td class="p-3">${bus.route}</td>
                            <td class="p-3">${bus.departsFrom}</td>
                            <td class="p-3">${bus.arrivesAt}</td>
                            <td class="p-3">${bus.departureTime}</td>
                            <td class="p-3">${bus.arrivalTime}</td>
                            <td class="p-3 text-sm">${(bus.availability || []).join(', ')}</td>
                            <td class="p-3 text-right">
                                <button class="edit-btn bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600" data-id="${bus.id}">Edit</button>
                                <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 ml-2" data-id="${bus.id}">Delete</button>
                            </td>
                        `;
                        busList.appendChild(row);
                    });

                    // Initialize SortableJS for drag-and-drop
                    if(sortableInstance) sortableInstance.destroy();
                    sortableInstance = new Sortable(busList, {
                        animation: 150,
                        ghostClass: 'ghost',
                        chosenClass: 'sortable-chosen',
                        onEnd: async (evt) => {
                            const orderedIds = Array.from(busList.children).map(row => row.dataset.id);
                            const batch = db.batch();
                            orderedIds.forEach((id, index) => {
                                const docRef = busesCollection.doc(id);
                                batch.update(docRef, { sortOrder: index });
                            });
                            await batch.commit();
                        }
                    });

                } catch (error) {
                    console.error("Error fetching buses: ", error);
                    busList.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-red-500">Failed to load data.</td></tr>';
                }
            };

            // Add Bus
            addBusForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const stops = document.getElementById('add-stops').value.split(',').map(s => s.trim()).filter(Boolean);
                const availability = getSelectedDays('add-');

                // Get the highest current sortOrder to append the new bus to the end
                const lastBusSnapshot = await busesCollection.orderBy('sortOrder', 'desc').limit(1).get();
                const lastOrder = lastBusSnapshot.empty ? -1 : lastBusSnapshot.docs[0].data().sortOrder;

                const newBus = {
                    route: document.getElementById('add-route').value,
                    operator: document.getElementById('add-operator').value,
                    departsFrom: document.getElementById('add-departsFrom').value,
                    arrivesAt: document.getElementById('add-arrivesAt').value,
                    departureTime: document.getElementById('add-departureTime').value,
                    arrivalTime: document.getElementById('add-arrivalTime').value,
                    price: document.getElementById('add-price').value,
                    stops: stops,
                    availability: availability,
                    sortOrder: lastOrder + 1
                };
                
                try {
                    await busesCollection.add(newBus);
                    addBusForm.reset();
                    document.getElementById('add-select-all-days').checked = false;
                    fetchAndDisplayBuses();
                } catch (error) {
                    console.error("Error adding bus: ", error);
                }
            });

            // Edit and Delete Event Delegation
            busList.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                if (e.target.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this route?')) {
                        try {
                            await busesCollection.doc(id).delete();
                            fetchAndDisplayBuses();
                        } catch (error) {
                            console.error("Error deleting bus: ", error);
                        }
                    }
                } else if (e.target.classList.contains('edit-btn')) {
                    const doc = await busesCollection.doc(id).get();
                    const bus = doc.data();
                    document.getElementById('edit-id').value = id;
                    document.getElementById('edit-route').value = bus.route;
                    document.getElementById('edit-operator').value = bus.operator;
                    document.getElementById('edit-departsFrom').value = bus.departsFrom;
                    document.getElementById('edit-arrivesAt').value = bus.arrivesAt;
                    document.getElementById('edit-departureTime').value = bus.departureTime;
                    document.getElementById('edit-arrivalTime').value = bus.arrivalTime;
                    document.getElementById('edit-price').value = bus.price;
                    document.getElementById('edit-stops').value = (bus.stops || []).join(', ');
                    
                    // Set availability checkboxes
                    document.querySelectorAll('input[name="edit-day"]').forEach(checkbox => {
                        checkbox.checked = (bus.availability || []).includes(checkbox.value);
                    });
                    document.getElementById('edit-select-all-days').checked = (bus.availability || []).length === 7;

                    editModal.classList.remove('hidden');
                }
            });
            
            // Save Edited Bus
            editBusForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-id').value;
                const stops = document.getElementById('edit-stops').value.split(',').map(s => s.trim()).filter(Boolean);
                const availability = getSelectedDays('edit-');

                const updatedBus = {
                    route: document.getElementById('edit-route').value,
                    operator: document.getElementById('edit-operator').value,
                    departsFrom: document.getElementById('edit-departsFrom').value,
                    arrivesAt: document.getElementById('edit-arrivesAt').value,
                    departureTime: document.getElementById('edit-departureTime').value,
                    arrivalTime: document.getElementById('edit-arrivalTime').value,
                    price: document.getElementById('edit-price').value,
                    stops: stops,
                    availability: availability
                };
                
                try {
                    await busesCollection.doc(id).update(updatedBus);
                    editModal.classList.add('hidden');
                    fetchAndDisplayBuses();
                } catch (error) {
                    console.error("Error updating bus: ", error);
                }
            });

            cancelEditButton.addEventListener('click', () => {
                editModal.classList.add('hidden');
            });
        }
    </script>
</body>
</html>

