<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Bus Timetable Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #config-warning {
            display: none;
            background-color: #fffbe6;
            color: #92400e;
            padding: 1rem;
            border: 1px solid #fde68a;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-4xl">
            <!-- Header -->
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">Find Your Bus</h1>
                <p class="text-gray-600 mt-2">Real-time bus schedules across the UK</p>
            </header>

            <!-- Config Warning -->
            <div id="config-warning">
                <strong>Configuration Needed:</strong> Please paste your Firebase config object into the HTML file to enable database connectivity.
            </div>

            <!-- Search Form -->
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <form id="search-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="relative">
                        <label for="from" class="block text-sm font-medium text-gray-700 mb-1">From</label>
                        <input type="text" id="from" placeholder="e.g., London Victoria" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="relative">
                        <label for="to" class="block text-sm font-medium text-gray-700 mb-1">To</label>
                        <input type="text" id="to" placeholder="e.g., Manchester" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="relative">
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-3">
                         <button type="submit" id="search-button" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-300 mt-2">Search Buses</button>
                    </div>
                </form>
            </div>

            <!-- Search Results -->
            <div id="results-container" class="mt-8">
                <!-- Results will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- IMPORTANT: CONFIGURE FIREBASE ---
        const firebaseConfig = {
            // PASTE YOUR FIREBASE CONFIG OBJECT HERE
            // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyATfiFaqfh0leWZMi8pq7OAgb5G7ANBv8o",
  authDomain: "sl-bus-timetable-app.firebaseapp.com",
  projectId: "sl-bus-timetable-app",
  storageBucket: "sl-bus-timetable-app.firebasestorage.app",
  messagingSenderId: "107324674333",
  appId: "1:107324674333:web:2058e8958f2c1dfd0c91f4",
  measurementId: "G-JEBZ0J484N"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
            apiKey: "AIzaSyATfiFaqfh0leWZMi8pq7OAgb5G7ANBv8o", // Added a placeholder key to check against
        };

        // --- SCRIPT INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const warningDiv = document.getElementById('config-warning');
            const searchButton = document.getElementById('search-button');
            const searchForm = document.getElementById('search-form');

            // 1. Check if Firebase config is still a placeholder
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "PASTE_HERE") {
                warningDiv.style.display = 'block';
                searchButton.disabled = true;
                searchButton.classList.add('opacity-50', 'cursor-not-allowed');
                console.error("Firebase config is missing. Please paste it into index.html.");
                return; // Stop execution if config is missing
            }

            // 2. Initialize Firebase only if config is valid
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const busesCollection = db.collection('buses');
            
            // Now, run the main application logic
            runApp(busesCollection);
        });


        function runApp(busesCollection) {
            const searchForm = document.getElementById('search-form');
            const resultsContainer = document.getElementById('results-container');
            const fromInput = document.getElementById('from');
            const toInput = document.getElementById('to');
            const dateInput = document.getElementById('date');

            // Set default date to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
            dateInput.min = `${yyyy}-${mm}-${dd}`;

            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const fromValue = fromInput.value.trim();
                const toValue = toInput.value.trim();
                const dateValue = dateInput.value;

                resultsContainer.innerHTML = `<p class="text-center text-gray-600 mt-8">Searching for buses...</p>`;

                try {
                    // Firestore requires a composite index for queries with 'where' on one field
                    // and 'orderBy' on another. To avoid this setup complexity for the user,
                    // we remove orderBy from the query and sort the results in the browser.
                    const snapshot = await busesCollection
                        .where('departsFrom', '==', fromValue)
                        .where('arrivesAt', '==', toValue)
                        .get();

                    if (snapshot.empty) {
                        displayNoResults();
                        return;
                    }

                    const searchDate = new Date(dateValue);
                    searchDate.setMinutes(searchDate.getMinutes() + searchDate.getTimezoneOffset());
                    const dayOfWeek = searchDate.toLocaleString('en-US', { weekday: 'long' });

                    const allBusesOnRoute = [];
                     snapshot.forEach(doc => {
                        allBusesOnRoute.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Filter by day of the week
                    const availableBuses = allBusesOnRoute.filter(bus => 
                        bus.availability && bus.availability.includes(dayOfWeek)
                    );

                    // Sort by departure time client-side
                    availableBuses.sort((a, b) => a.departureTime.localeCompare(b.departureTime));


                    if (availableBuses.length > 0) {
                        displayResults(availableBuses);
                    } else {
                        displayNoResults(true); // true indicates buses exist but not on this day
                    }

                } catch (error) {
                    console.error("Error searching for buses: ", error);
                    // Check for index error specifically
                    if (error.code === 'failed-precondition') {
                         resultsContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Error: A database index is required for this query. Please check the browser console for a link to create it in Firebase.</p>`;
                    } else {
                         resultsContainer.innerHTML = `<p class="text-center text-red-500 mt-8">An error occurred. Please try again.</p>`;
                    }
                }
            });
            
            const displayNoResults = (isDayMismatch = false) => {
                const message = isDayMismatch 
                    ? `No buses run on this route on the selected day.`
                    : `No direct bus routes found from "${fromInput.value}" to "${toInput.value}".`;
                resultsContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <h3 class="text-lg font-semibold text-gray-700">${message}</h3>
                        <p class="text-gray-500 mt-2">Please check your spelling or try a different date.</p>
                    </div>`;
            };
            
            const displayResults = (buses) => {
                resultsContainer.innerHTML = '';
                buses.forEach(bus => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow-md mb-4 animate-fade-in';
                    card.innerHTML = `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-center">
                            <!-- Route and Operator -->
                            <div class="col-span-2 md:col-span-1">
                                <p class="text-xl font-bold text-blue-600">${bus.route}</p>
                                <p class="text-sm text-gray-500">${bus.operator}</p>
                            </div>

                            <!-- Departure and Arrival -->
                            <div class="text-center">
                                <p class="text-2xl font-semibold text-gray-800">${bus.departureTime}</p>
                                <p class="text-sm text-gray-600">${bus.departsFrom}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-2xl font-semibold text-gray-800">${bus.arrivalTime}</p>
                                <p class="text-sm text-gray-600">${bus.arrivesAt}</p>
                            </div>

                            <!-- Price -->
                            <div class="col-span-2 md:col-span-1 text-center md:text-right">
                                <p class="text-2xl font-bold text-green-600">${bus.price || ''}</p>
                            </div>
                        </div>
                        ${bus.stops && bus.stops.length > 0 ? `
                        <div class="border-t mt-4 pt-4">
                            <p class="text-sm font-medium text-gray-700">Stops: <span class="font-normal text-gray-600">${bus.stops.join(' &rarr; ')}</span></p>
                        </div>` : ''}
                    `;
                    resultsContainer.appendChild(card);
                });
            };

            // Simple fade-in animation
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes fade-in {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .animate-fade-in {
                    animation: fade-in 0.5s ease-out forwards;
                }
            `;
            document.head.appendChild(style);
        }
    </script>

</body>
</html>

