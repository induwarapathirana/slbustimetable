<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Lanka Expressway Bus Timetable Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        details summary::marker { color: transparent; }
        details summary { list-style: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Find Your Bus</h1>
            <p class="text-gray-600 mt-2">Real-time bus schedules across the Expressways Sri Lanka</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <form id="search-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-1 relative">
                    <label for="from" class="block text-sm font-medium text-gray-700">From</label>
                    <input type="text" id="from" placeholder="e.g., Makumbura" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <div id="from-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 hidden"></div>
                </div>
                <div class="md:col-span-1 relative">
                    <label for="to" class="block text-sm font-medium text-gray-700">To</label>
                    <input type="text" id="to" placeholder="e.g., Galle" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <div id="to-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 hidden"></div>
                </div>
                <div class="md:col-span-1">
                    <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="md:col-span-1">
                    <button type="submit" id="search-button" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-semibold">Search</button>
                </div>
            </form>
        </div>

        <div id="error-message" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg relative mb-6" role="alert"></div>

        <div id="search-meta" class="hidden bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-6"></div>

        <div id="search-results" class="space-y-4">
            <!-- Search results will be appended here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchForm = document.getElementById('search-form');
            const searchButton = document.getElementById('search-button');
            const searchResults = document.getElementById('search-results');
            const errorMessage = document.getElementById('error-message');
            const fromInput = document.getElementById('from');
            const toInput = document.getElementById('to');
            const fromSuggestions = document.getElementById('from-suggestions');
            const toSuggestions = document.getElementById('to-suggestions');
            const dateInput = document.getElementById('date');
            const searchMeta = document.getElementById('search-meta');

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;

            let allLocations = new Set();
            const LAST_SEARCH_KEY = 'slbustimetable:last-search';

            async function loadLocations() {
                try {
                    const response = await fetch('/api/locations');
                    if (!response.ok) throw new Error('Failed to fetch locations');
                    const data = await response.json();
                    allLocations = new Set(data.locations || []);
                } catch (error) {
                    console.error('Error fetching locations:', error);
                }
            }

            loadLocations();

            const handleAutocomplete = (input, suggestionsContainer) => {
                const query = input.value.toLowerCase().trim();
                suggestionsContainer.innerHTML = '';
                if (!query) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                const filtered = [...allLocations]
                    .filter(loc => loc.toLowerCase().includes(query))
                    .slice(0, 6);
                if (filtered.length === 0) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                suggestionsContainer.classList.remove('hidden');
                filtered.forEach(loc => {
                    const div = document.createElement('div');
                    div.textContent = loc;
                    div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                    div.onclick = () => {
                        input.value = loc;
                        suggestionsContainer.classList.add('hidden');
                    };
                    suggestionsContainer.appendChild(div);
                });
            };

            fromInput.addEventListener('input', () => handleAutocomplete(fromInput, fromSuggestions));
            toInput.addEventListener('input', () => handleAutocomplete(toInput, toSuggestions));
            document.addEventListener('click', (event) => {
                if (!fromInput.contains(event.target)) fromSuggestions.classList.add('hidden');
                if (!toInput.contains(event.target)) toSuggestions.classList.add('hidden');
            });

            const cached = localStorage.getItem(LAST_SEARCH_KEY);
            if (cached) {
                try {
                    const parsed = JSON.parse(cached);
                    fromInput.value = parsed.from || '';
                    toInput.value = parsed.to || '';
                    dateInput.value = parsed.date || dateInput.value;
                    if (parsed.results) {
                        displayResults(parsed.results, parsed.meta);
                    }
                } catch (err) {
                    localStorage.removeItem(LAST_SEARCH_KEY);
                }
            }

            searchForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const fromValue = fromInput.value.trim();
                const toValue = toInput.value.trim();
                const dateValue = dateInput.value;

                if (!fromValue || !toValue || !dateValue) {
                    return displayError('Please fill in all fields.');
                }

                const searchDate = new Date(dateValue);
                searchDate.setHours(12);
                const dayOfWeek = searchDate.toLocaleString('en-US', { weekday: 'long' });

                performSearch(fromValue.toLowerCase(), toValue.toLowerCase(), dateValue, dayOfWeek);
            });

            async function performSearch(from, to, date, dayOfWeek) {
                searchButton.disabled = true;
                searchButton.textContent = 'Searching...';
                errorMessage.classList.add('hidden');
                searchResults.innerHTML = '<div class="text-center p-4">Loading results...</div>';

                try {
                    const response = await fetch(`/api/search?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&date=${encodeURIComponent(date)}`);
                    if (!response.ok) throw new Error('Failed to fetch results');
                    const data = await response.json();
                    const results = Array.isArray(data.buses) ? data.buses : [];
                    displayResults(results, data.meta);
                    localStorage.setItem(LAST_SEARCH_KEY, JSON.stringify({
                        from: fromInput.value,
                        to: toInput.value,
                        date,
                        results,
                        meta: data.meta
                    }));
                } catch (error) {
                    console.error('Search error:', error);
                    displayError('Unable to load results right now. Please try again in a moment.');
                    searchResults.innerHTML = '';
                    searchMeta.classList.add('hidden');
                } finally {
                    searchButton.disabled = false;
                    searchButton.textContent = 'Search';
                }
            }

            function displayResults(results, meta = null) {
                if (!Array.isArray(results) || results.length === 0) {
                    searchResults.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow text-center">
                            <h3 class="text-xl font-semibold mb-2">No buses found</h3>
                            <p class="text-gray-600">Try adjusting your search criteria or checking back later.</p>
                        </div>`;
                    searchMeta.classList.add('hidden');
                    return;
                }

                const now = new Date();
                const highlightIndex = findNextDepartureIndex(results, now);
                searchResults.innerHTML = '';

                if (meta) {
                    searchMeta.classList.remove('hidden');
                    searchMeta.innerHTML = `
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div>
                                <p class="text-sm text-gray-500 uppercase tracking-wide">Journey</p>
                                <p class="text-xl font-semibold text-gray-800">${meta.from} → ${meta.to}</p>
                            </div>
                            <div class="text-sm text-gray-600">
                                <span class="font-semibold">${meta.dayOfWeek}</span> · ${meta.total} result${meta.total === 1 ? '' : 's'}
                            </div>
                        </div>`;
                }

                results.forEach((bus, index) => {
                    const availability = Array.isArray(bus.availability) && bus.availability.length > 0 ? bus.availability.join(', ') : 'Runs daily';
                    const stops = Array.isArray(bus.stops) && bus.stops.length > 0 ? bus.stops.join(', ') : 'Non-stop or not listed';
                    const isHighlighted = index === highlightIndex;

                    const card = document.createElement('div');
                    card.className = `bg-white p-6 rounded-lg shadow-md border ${isHighlighted ? 'border-indigo-500 ring-2 ring-indigo-200' : 'border-gray-200 hover:border-indigo-400'} transition`;
                    card.innerHTML = `
                        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm uppercase tracking-wide text-gray-500">${bus.route || 'Unspecified Route'}</p>
                                    ${renderStatusBadge(bus.status)}
                                    ${isHighlighted ? '<span class="px-2 py-1 text-xs font-semibold bg-indigo-100 text-indigo-700 rounded-full">Next departure</span>' : ''}
                                </div>
                                <h2 class="text-2xl font-bold text-gray-800 mt-1">${bus.departsFrom} → ${bus.arrivesAt}</h2>
                                <p class="text-gray-600 mt-1">Operated by <span class="font-semibold">${bus.operator}</span></p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-semibold text-indigo-600">${bus.departureTime} → ${bus.arrivalTime || 'N/A'}</p>
                                <p class="text-sm text-gray-500">${availability}</p>
                            </div>
                        </div>

                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                            <div>
                                <p><span class="font-semibold">Expressway Entrance:</span> ${bus.expresswayEntrance || 'Not listed'}</p>
                                <p><span class="font-semibold">Expressway Exit:</span> ${bus.expresswayExit || 'Not listed'}</p>
                            </div>
                            <div>
                                <p><span class="font-semibold">Price:</span> ${bus.price || 'Contact operator'}</p>
                                <p><span class="font-semibold">Stops:</span> ${stops}</p>
                            </div>
                        </div>

                        <details class="mt-4 bg-gray-50 rounded-md p-3 text-sm text-gray-600">
                            <summary class="cursor-pointer font-semibold text-gray-700">Schedule notes</summary>
                            <p class="mt-2">Updated ${formatRelativeTime(bus.updatedAt || bus.createdAt)}. Availability: ${availability}.</p>
                        </details>

                        <div class="mt-4 flex flex-wrap gap-2">
                            ${(bus.availability || []).map(day => `<span class="px-3 py-1 bg-indigo-50 text-indigo-600 text-xs font-semibold rounded-full">${day}</span>`).join('')}
                        </div>`;
                    searchResults.appendChild(card);
                });
            }

            function displayError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            }

            function findNextDepartureIndex(results, now) {
                if (!Array.isArray(results) || results.length === 0) return -1;
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const idx = results.findIndex(bus => (bus.departureTime || '') >= currentTime);
                return idx === -1 ? 0 : idx;
            }

            function renderStatusBadge(status) {
                const map = {
                    'Scheduled': 'bg-gray-100 text-gray-700',
                    'Departed': 'bg-green-100 text-green-700',
                    'Arrived': 'bg-blue-100 text-blue-700',
                    'Delayed': 'bg-yellow-100 text-yellow-700',
                    'Cancelled': 'bg-red-100 text-red-700'
                };
                const classes = map[status] || map['Scheduled'];
                return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${classes}">${status || 'Scheduled'}</span>`;
            }

            function formatRelativeTime(timestamp) {
                if (!timestamp) return 'recently';
                const updated = new Date(timestamp);
                if (Number.isNaN(updated.getTime())) return 'recently';
                const diffMinutes = Math.floor((Date.now() - updated.getTime()) / 60000);
                if (diffMinutes < 1) return 'just now';
                if (diffMinutes < 60) return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            }
        });
    </script>
</body>
</html>
