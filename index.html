<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Lanka Expressway Bus Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
        }
        .glass-panel {
            backdrop-filter: blur(18px);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.88), rgba(30, 41, 59, 0.78));
            border: 1px solid rgba(148, 163, 184, 0.25);
        }
        .suggestions-panel {
            box-shadow: 0 18px 45px -15px rgba(15, 23, 42, 0.35);
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <div class="relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-indigo-950 via-slate-950 to-slate-900"></div>
        <div class="pointer-events-none absolute inset-0 opacity-50" aria-hidden="true">
            <div class="absolute -top-24 -left-24 w-72 h-72 bg-indigo-500/30 blur-3xl rounded-full"></div>
            <div class="absolute -bottom-32 right-0 w-96 h-96 bg-blue-500/20 blur-3xl rounded-full"></div>
        </div>
        <div class="relative z-10">
            <header class="max-w-5xl mx-auto px-6 pt-12 pb-8 text-center">
                <p class="text-sm font-semibold uppercase tracking-[0.3em] text-indigo-300">Sri Lanka Expressway Network</p>
                <h1 class="mt-4 text-4xl md:text-5xl font-extrabold text-white">Plan your next express departure in seconds</h1>
                <p class="mt-4 text-base md:text-lg text-slate-300 max-w-3xl mx-auto">Search live expressway departures, compare operators, and see real-time status updates for any date. Crafted for commuters, timekeepers, and travellers alike.</p>
            </header>

            <main class="max-w-5xl mx-auto px-6 pb-16">
                <section class="glass-panel rounded-3xl p-6 md:p-8 shadow-2xl">
                    <form id="search-form" class="grid grid-cols-1 md:grid-cols-[repeat(4,minmax(0,1fr))] gap-4 items-end" autocomplete="off">
                        <div class="relative">
                            <label for="from" class="block text-xs font-semibold uppercase tracking-wide text-indigo-200">From</label>
                            <input type="text" id="from" name="from" placeholder="e.g. Makumbura" class="mt-2 w-full rounded-xl border border-slate-700 bg-slate-900/70 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/60" aria-autocomplete="list" aria-controls="from-suggestions" aria-expanded="false">
                            <div id="from-suggestions" class="suggestions-panel absolute z-20 mt-2 hidden w-full overflow-hidden rounded-xl border border-slate-700/70 bg-slate-900/95 text-left" role="listbox"></div>
                        </div>
                        <div class="relative">
                            <label for="to" class="block text-xs font-semibold uppercase tracking-wide text-indigo-200">To</label>
                            <input type="text" id="to" name="to" placeholder="e.g. Galle" class="mt-2 w-full rounded-xl border border-slate-700 bg-slate-900/70 px-4 py-3 text-slate-100 placeholder:text-slate-500 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/60" aria-autocomplete="list" aria-controls="to-suggestions" aria-expanded="false">
                            <div id="to-suggestions" class="suggestions-panel absolute z-20 mt-2 hidden w-full overflow-hidden rounded-xl border border-slate-700/70 bg-slate-900/95 text-left" role="listbox"></div>
                        </div>
                        <div>
                            <label for="date" class="block text-xs font-semibold uppercase tracking-wide text-indigo-200">Date</label>
                            <input type="date" id="date" name="date" class="mt-2 w-full rounded-xl border border-slate-700 bg-slate-900/70 px-4 py-3 text-slate-100 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-400/60">
                        </div>
                        <div>
                            <button type="submit" id="search-button" class="mt-6 w-full rounded-xl bg-gradient-to-r from-indigo-500 via-blue-500 to-cyan-500 py-3 text-sm font-semibold uppercase tracking-wide text-white shadow-lg shadow-indigo-500/20 transition hover:shadow-indigo-500/40 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 focus:ring-offset-slate-950">Search departures</button>
                        </div>
                    </form>
                </section>

                <section id="config-warning" class="mt-6 hidden rounded-2xl border border-red-400/50 bg-red-900/40 px-6 py-4 text-red-100" role="alert">
                    <p class="font-semibold">Configuration missing</p>
                    <p class="text-sm text-red-200">Firebase configuration was not detected. Please paste your project credentials into this file.</p>
                </section>

                <section id="error-message" class="mt-6 hidden rounded-2xl border border-amber-300/40 bg-amber-900/40 px-6 py-4 text-amber-100" role="alert"></section>

                <div id="results-summary" class="mt-8 hidden text-sm text-slate-300"></div>

                <div id="search-results" class="mt-6 space-y-6" aria-live="polite" aria-busy="false"></div>
                <div id="live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
            </main>
        </div>
    </div>

    <script type="module">
        import { getApp, getApps, initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import {
            getFirestore,
            collection,
            onSnapshot,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // --- Firebase bootstrap -------------------------------------------------
        // Replace only the property values with your Firebase project keys. The
        // modular CDN imports above rely on this object shape remaining intact.
        const firebaseConfig = {
            apiKey: "AIzaSyATfiFaqfh0leWZMi8pq7OAgb5G7ANBv8o",
            authDomain: "sl-bus-timetable-app.firebaseapp.com",
            projectId: "sl-bus-timetable-app",
            storageBucket: "sl-bus-timetable-app.firebasestorage.app",
            messagingSenderId: "107324674333",
            appId: "1:107324674333:web:2058e8958f2c1dfd0c91f4",
            measurementId: "G-JEBZ0J484N"
        };

        document.addEventListener('DOMContentLoaded', () => {
            const configWarning = document.getElementById('config-warning');
            if (!firebaseConfig.apiKey) {
                configWarning.classList.remove('hidden');
                return;
            }

            // Share the Firebase app across the rider UI so repeated navigations do not
            // instantiate multiple app instances (which would log console warnings).
            const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
            const db = getFirestore(app);

            const searchForm = document.getElementById('search-form');
            const searchButton = document.getElementById('search-button');
            const searchResults = document.getElementById('search-results');
            const resultsSummary = document.getElementById('results-summary');
            const errorMessage = document.getElementById('error-message');
            const liveRegion = document.getElementById('live-region');
            const fromInput = document.getElementById('from');
            const toInput = document.getElementById('to');
            const fromSuggestions = document.getElementById('from-suggestions');
            const toSuggestions = document.getElementById('to-suggestions');
            const dateInput = document.getElementById('date');

            const stored = window.localStorage.getItem('sl-bus-last-search');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (parsed.from) fromInput.value = parsed.from;
                    if (parsed.to) toInput.value = parsed.to;
                    if (parsed.date) dateInput.value = parsed.date;
                } catch (_) {
                    /* ignore malformed cache */
                }
            }

            if (!dateInput.value) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }

            let allLocations = new Set();
            let baseUnsubscribe = null;
            let specialUnsubscribe = null;
            let baseResults = [];
            let specialResults = [];
            let lastSearchMeta = null;

            onSnapshot(collection(db, 'buses'), snapshot => {
                const nextLocations = new Set();
                snapshot.forEach(doc => {
                    const bus = doc.data();
                    if (bus.departsFrom) nextLocations.add(bus.departsFrom.trim());
                    if (bus.arrivesAt) nextLocations.add(bus.arrivesAt.trim());
                    if (bus.expresswayEntrance) nextLocations.add(bus.expresswayEntrance.trim());
                    if (bus.expresswayExit) nextLocations.add(bus.expresswayExit.trim());
                });
                allLocations = nextLocations;
            });

            onSnapshot(collection(db, 'priceMatrix'), snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.origin) allLocations.add(data.origin.trim());
                    if (data.destination) allLocations.add(data.destination.trim());
                });
            });

            const handleAutocomplete = (input, container) => {
                const query = input.value.toLowerCase().trim();
                container.innerHTML = '';
                if (!query) {
                    container.classList.add('hidden');
                    input.setAttribute('aria-expanded', 'false');
                    return;
                }
                const matches = [...allLocations].filter(loc => loc.toLowerCase().includes(query)).slice(0, 7);
                if (!matches.length) {
                    container.classList.add('hidden');
                    input.setAttribute('aria-expanded', 'false');
                    return;
                }
                container.classList.remove('hidden');
                input.setAttribute('aria-expanded', 'true');
                matches.forEach((loc, index) => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'w-full px-4 py-2 text-left text-sm text-slate-200 hover:bg-slate-800 focus:bg-slate-800 focus:outline-none';
                    option.textContent = loc;
                    option.id = `${input.id}-suggestion-${index}`;
                    option.setAttribute('role', 'option');
                    option.addEventListener('click', () => {
                        input.value = loc;
                        container.classList.add('hidden');
                        input.setAttribute('aria-expanded', 'false');
                        input.focus();
                    });
                    container.appendChild(option);
                });
            };

            fromInput.addEventListener('input', () => handleAutocomplete(fromInput, fromSuggestions));
            toInput.addEventListener('input', () => handleAutocomplete(toInput, toSuggestions));
            document.addEventListener('click', (event) => {
                if (!fromSuggestions.contains(event.target) && event.target !== fromInput) {
                    fromSuggestions.classList.add('hidden');
                    fromInput.setAttribute('aria-expanded', 'false');
                }
                if (!toSuggestions.contains(event.target) && event.target !== toInput) {
                    toSuggestions.classList.add('hidden');
                    toInput.setAttribute('aria-expanded', 'false');
                }
            });

            searchForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const fromValue = fromInput.value.trim();
                const toValue = toInput.value.trim();
                const dateValue = dateInput.value;

                if (!fromValue || !toValue || !dateValue) {
                    displayError('Please fill in every field before searching.');
                    return;
                }

                errorMessage.classList.add('hidden');
                resultsSummary.classList.add('hidden');
                searchResults.setAttribute('aria-busy', 'true');
                searchResults.innerHTML = '<div class="rounded-2xl border border-slate-700/60 bg-slate-900/60 px-4 py-6 text-center text-sm text-slate-300">Fetching departures...</div>';
                liveRegion.textContent = 'Searching departures';

                window.localStorage.setItem('sl-bus-last-search', JSON.stringify({ from: fromValue, to: toValue, date: dateValue }));

                const searchDate = new Date(`${dateValue}T00:00:00`);
                const dayOfWeek = searchDate.toLocaleString('en-US', { weekday: 'long' });

                lastSearchMeta = { from: fromValue, to: toValue, date: dateValue, dayOfWeek };

                if (baseUnsubscribe) baseUnsubscribe();
                if (specialUnsubscribe) specialUnsubscribe();
                baseResults = [];
                specialResults = [];

                const baseQuery = query(collection(db, 'buses'), where('availability', 'array-contains', dayOfWeek));

                baseUnsubscribe = onSnapshot(baseQuery, snapshot => {
                    baseResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    mergeAndRender();
                }, handleQueryError);

                const specialQuery = query(collection(db, 'buses'), where('specialDates', 'array-contains', dateValue));
                specialUnsubscribe = onSnapshot(specialQuery, snapshot => {
                        specialResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        mergeAndRender();
                    }, handleQueryError);
            });

            function mergeAndRender() {
                if (!lastSearchMeta) return;
                const combinedMap = new Map();
                baseResults.concat(specialResults).forEach(bus => combinedMap.set(bus.id, bus));
                const merged = Array.from(combinedMap.values());
                const filtered = merged.filter(bus => matchesRoute(bus, lastSearchMeta.from, lastSearchMeta.to));
                filtered.sort((a, b) => compareTimes(a.departureTime, b.departureTime));
                displayResults(filtered, lastSearchMeta);
            }

            function matchesRoute(bus, fromValue, toValue) {
                const from = fromValue.toLowerCase();
                const to = toValue.toLowerCase();
                const departsFrom = (bus.departsFrom || '').toLowerCase();
                const arrivesAt = (bus.arrivesAt || '').toLowerCase();
                const expresswayEntrance = (bus.expresswayEntrance || '').toLowerCase();
                const expresswayExit = (bus.expresswayExit || '').toLowerCase();

                const fromMatch = departsFrom === from || expresswayEntrance === from;
                const toMatch = arrivesAt === to || expresswayExit === to;
                return fromMatch && toMatch;
            }

            function handleQueryError(error) {
                console.error('Query error:', error);
                displayError('We could not reach the timetable right now. Please try again in a moment.');
                searchResults.setAttribute('aria-busy', 'false');
                searchButton.disabled = false;
                searchButton.textContent = 'Search departures';
            }

            function displayResults(buses, meta) {
                searchButton.disabled = false;
                searchButton.textContent = 'Search departures';
                searchResults.setAttribute('aria-busy', 'false');
                searchResults.innerHTML = '';

                if (!buses.length) {
                    resultsSummary.classList.remove('hidden');
                    resultsSummary.innerHTML = `<span class="font-semibold text-slate-100">No departures found</span> for <span class="text-indigo-300">${meta.from}</span> → <span class="text-indigo-300">${meta.to}</span> on ${formatHumanDate(meta.date)}.`;
                    searchResults.innerHTML = '<div class="rounded-2xl border border-slate-700/60 bg-slate-900/60 px-6 py-8 text-center text-sm text-slate-300">Try adjusting your locations or choosing a different date.</div>';
                    liveRegion.textContent = 'No departures found';
                    return;
                }

                const highlightIndex = findNextDepartureIndex(buses, meta.date);
                resultsSummary.classList.remove('hidden');
                resultsSummary.innerHTML = `<span class="font-semibold text-slate-100">${buses.length} departures</span> from <span class="text-indigo-300">${meta.from}</span> to <span class="text-indigo-300">${meta.to}</span> on ${formatHumanDate(meta.date)}.`;

                buses.forEach((bus, index) => {
                    const card = document.createElement('article');
                    card.className = `group relative overflow-hidden rounded-3xl border border-slate-800 bg-slate-900/70 p-6 transition shadow-xl shadow-indigo-900/10 hover:border-indigo-500/60 hover:shadow-indigo-500/30`;
                    if (index === highlightIndex) {
                        card.classList.add('ring-2', 'ring-indigo-400/80', 'ring-offset-2', 'ring-offset-slate-950');
                    }

                    const statusBadge = renderStatusBadge(bus.status);
                    const priceTag = bus.price ? `<span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/10 px-4 py-1 text-sm font-semibold text-emerald-200 border border-emerald-500/30">${bus.price}</span>` : '';
                    const availabilityBadges = renderAvailabilityBadges(bus.availability);
                    const stopsBlock = renderStops(bus.stops);

                    card.innerHTML = `
                        <div class="flex flex-col gap-4">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <h2 class="text-2xl font-bold text-white">${bus.route || 'Express Service'}</h2>
                                        ${statusBadge}
                                        ${index === highlightIndex ? '<span class="inline-flex items-center gap-1 rounded-full bg-indigo-500/20 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-100">Next departure</span>' : ''}
                                    </div>
                                    <p class="text-sm text-slate-300">${bus.operator || 'Operator not specified'}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm uppercase tracking-wide text-slate-400">Departure</p>
                                    <p class="text-3xl font-bold text-white">${bus.departureTime || 'TBC'}</p>
                                    ${bus.arrivalTime ? `<p class="mt-1 text-xs text-slate-400">Arrives ${bus.arrivalTime}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-3 text-sm text-slate-200">
                                <span class="inline-flex items-center gap-2 rounded-full bg-slate-800/60 px-3 py-1"><span class="font-semibold text-slate-100">Departs</span> ${bus.departsFrom || '—'}</span>
                                <span class="inline-flex items-center gap-2 rounded-full bg-slate-800/60 px-3 py-1"><span class="font-semibold text-slate-100">Arrives</span> ${bus.arrivesAt || '—'}</span>
                                ${bus.expresswayEntrance ? `<span class="inline-flex items-center gap-2 rounded-full bg-slate-800/60 px-3 py-1"><span class="font-semibold text-slate-100">Entrance</span> ${bus.expresswayEntrance}</span>` : ''}
                                ${bus.expresswayExit ? `<span class="inline-flex items-center gap-2 rounded-full bg-slate-800/60 px-3 py-1"><span class="font-semibold text-slate-100">Exit</span> ${bus.expresswayExit}</span>` : ''}
                                ${priceTag}
                            </div>
                            ${availabilityBadges}
                            ${stopsBlock}
                        </div>
                    `;

                    searchResults.appendChild(card);
                });

                liveRegion.textContent = `${buses.length} departures found`;
            }

            function displayError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            }

            function compareTimes(timeA, timeB) {
                const toMinutes = (time) => {
                    if (!time) return Number.MAX_SAFE_INTEGER;
                    const [hours, minutes] = time.split(':').map(Number);
                    if (Number.isNaN(hours) || Number.isNaN(minutes)) return Number.MAX_SAFE_INTEGER;
                    return hours * 60 + minutes;
                };
                return toMinutes(timeA) - toMinutes(timeB);
            }

            function findNextDepartureIndex(buses, isoDate) {
                if (!buses.length) return -1;
                const todayIso = formatDate(new Date());
                const currentMinutes = (() => {
                    const now = new Date();
                    return now.getHours() * 60 + now.getMinutes();
                })();
                if (isoDate !== todayIso) return 0;
                const index = buses.findIndex(bus => {
                    const [hours, minutes] = (bus.departureTime || '').split(':').map(Number);
                    if (Number.isNaN(hours) || Number.isNaN(minutes)) return false;
                    return hours * 60 + minutes >= currentMinutes;
                });
                return index === -1 ? 0 : index;
            }

            function renderStatusBadge(status) {
                const config = getStatusConfig(status);
                return `<span class="inline-flex items-center gap-2 rounded-full border ${config.border} ${config.bg} px-3 py-1 text-xs font-semibold ${config.text}">
                    <span class="inline-flex h-2 w-2 rounded-full ${config.dot}"></span>
                    ${config.label}
                </span>`;
            }

            function getStatusConfig(status) {
                const defaultConfig = { label: 'Scheduled', bg: 'bg-slate-800/60', border: 'border-slate-600/60', text: 'text-slate-200', dot: 'bg-slate-300' };
                const map = {
                    'Departed': { label: 'Departed', bg: 'bg-emerald-500/15', border: 'border-emerald-400/40', text: 'text-emerald-200', dot: 'bg-emerald-300' },
                    'Arrived': { label: 'Arrived', bg: 'bg-sky-500/15', border: 'border-sky-400/40', text: 'text-sky-200', dot: 'bg-sky-300' },
                    'Delayed': { label: 'Delayed', bg: 'bg-amber-500/15', border: 'border-amber-400/40', text: 'text-amber-200', dot: 'bg-amber-300' },
                    'Cancelled': { label: 'Cancelled', bg: 'bg-rose-500/15', border: 'border-rose-400/40', text: 'text-rose-200', dot: 'bg-rose-300' }
                };
                return map[status] || defaultConfig;
            }

            function renderAvailabilityBadges(days = []) {
                if (!Array.isArray(days) || !days.length) return '';
                const items = days.map(day => `<span class="inline-flex items-center gap-2 rounded-full bg-slate-800/60 px-3 py-1 text-xs text-slate-300">${day}</span>`).join('');
                return `<div class="flex flex-wrap items-center gap-2" aria-label="Operating days">${items}</div>`;
            }

            function renderStops(stops = []) {
                if (!Array.isArray(stops) || !stops.length) {
                    return '';
                }
                const preview = stops.slice(0, 3).join(' • ');
                const remainder = stops.slice(3).map(stop => `<li class="rounded-xl border border-slate-700/70 bg-slate-900/70 px-3 py-1 text-sm text-slate-200">${stop}</li>`).join('');
                const extraCount = stops.length - 3;
                if (remainder) {
                    return `
                        <details class="group rounded-2xl border border-slate-800 bg-slate-900/50 px-4 py-3 text-sm text-slate-300">
                            <summary class="flex cursor-pointer list-none items-center justify-between text-slate-200 hover:text-white">
                                <span class="font-semibold">Stops</span>
                                <span class="text-xs text-indigo-300 group-open:hidden">+${extraCount} more</span>
                                <span class="text-xs text-indigo-300 hidden group-open:block">Hide</span>
                            </summary>
                            <div class="mt-3 text-sm">${preview}</div>
                            <ul class="mt-3 grid gap-2 md:grid-cols-2">${remainder}</ul>
                        </details>`;
                }
                return `<div class="rounded-2xl border border-slate-800 bg-slate-900/50 px-4 py-3 text-sm text-slate-300"><span class="font-semibold text-slate-100">Stops:</span> ${preview}</div>`;
            }

            function formatHumanDate(isoDate) {
                const date = new Date(`${isoDate}T00:00:00`);
                if (Number.isNaN(date.getTime())) return isoDate;
                return date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
            }

            function formatDate(date) {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }
        });
    </script>
</body>
</html>
